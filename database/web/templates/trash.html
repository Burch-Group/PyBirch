{% extends "base.html" %}

{% block title %}Trash - PyBirch Database{% endblock %}

{% block content %}
<div class="list-page">
    <div class="page-header">
        <h1>üóëÔ∏è Trash</h1>
        <p class="page-description">Items in trash will be permanently deleted after 30 days.</p>
    </div>
    
    <div class="trash-layout">
        <!-- Sidebar with entity type filter -->
        <aside class="trash-sidebar">
            <h3>Filter by Type</h3>
            <ul class="trash-type-list">
                <li class="{% if not entity_type %}active{% endif %}">
                    <a href="{{ url_for('main.trash') }}">All Types</a>
                    <span class="badge">{{ stats.values() | sum }}</span>
                </li>
                {% for type_name, count in stats.items() %}
                {% if count > 0 %}
                <li class="{% if entity_type == type_name %}active{% endif %}">
                    <a href="{{ url_for('main.trash', type=type_name) }}">{{ type_name | replace('_', ' ') | title }}</a>
                    <span class="badge">{{ count }}</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
            
            {% if current_user and current_user.role == 'admin' %}
            <div class="trash-actions">
                <button id="cleanup-expired-btn" class="btn btn-danger btn-sm">
                    Clean Up Expired Items
                </button>
            </div>
            {% endif %}
        </aside>
        
        <!-- Main content area -->
        <main class="trash-content">
            {% if entity_type %}
                <h2>Trashed {{ entity_type | replace('_', ' ') | title }}s</h2>
                
                {% if items %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name/ID</th>
                            <th>Trashed By</th>
                            <th>Trashed At</th>
                            <th>Days Until Deletion</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-entity-type="{{ entity_type }}" data-entity-id="{{ item.id }}">
                            <td class="item-name">
                                {% if item.name %}
                                    {{ item.name }}
                                {% elif item.sample_id %}
                                    {{ item.sample_id }}
                                {% elif item.title %}
                                    {{ item.title }}
                                {% elif item.filename %}
                                    {{ item.filename }}
                                {% else %}
                                    #{{ item.id }}
                                {% endif %}
                            </td>
                            <td>{{ item.trashed_by or 'Unknown' }}</td>
                            <td>{{ item.trashed_at[:19] if item.trashed_at else '-' }}</td>
                            <td>
                                {% set days_left = item.days_until_permanent_deletion %}
                                {% if days_left is not none %}
                                    <span class="{% if days_left <= 7 %}text-danger{% elif days_left <= 14 %}text-warning{% endif %}">
                                        {{ days_left }} days
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td class="trash-item-actions">
                                <button class="btn btn-sm btn-primary restore-btn" 
                                        data-entity-type="{{ entity_type }}" 
                                        data-entity-id="{{ item.id }}"
                                        title="Restore item">
                                    ‚Ü©Ô∏è Restore
                                </button>
                                <button class="btn btn-sm btn-danger permanent-delete-btn" 
                                        data-entity-type="{{ entity_type }}" 
                                        data-entity-id="{{ item.id }}"
                                        title="Permanently delete">
                                    ‚ùå Delete Forever
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-results">No trashed {{ entity_type | replace('_', ' ') }}s found.</p>
                {% endif %}
            {% else %}
                <div class="trash-overview">
                    <h2>Trash Overview</h2>
                    <p>Select a type from the sidebar to view and manage trashed items.</p>
                    
                    {% if stats.values() | sum == 0 %}
                    <div class="empty-trash-message">
                        <div class="empty-icon">üóëÔ∏è</div>
                        <h3>Trash is empty</h3>
                        <p>No items have been deleted.</p>
                    </div>
                    {% else %}
                    <div class="trash-stats-grid">
                        {% for type_name, count in stats.items() %}
                        {% if count > 0 %}
                        <a href="{{ url_for('main.trash', type=type_name) }}" class="trash-stat-card">
                            <div class="stat-count">{{ count }}</div>
                            <div class="stat-label">{{ type_name | replace('_', ' ') | title }}s</div>
                        </a>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </main>
    </div>
</div>

<style>
.trash-layout {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
}

.trash-sidebar {
    width: 250px;
    flex-shrink: 0;
}

.trash-sidebar h3 {
    margin-bottom: 1rem;
    font-size: 1rem;
    color: var(--text-secondary);
}

.trash-type-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.trash-type-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    margin-bottom: 0.25rem;
}

.trash-type-list li:hover {
    background: var(--bg-secondary);
}

.trash-type-list li.active {
    background: var(--primary-color);
}

.trash-type-list li.active a {
    color: white;
}

.trash-type-list a {
    color: var(--text-primary);
    text-decoration: none;
    flex-grow: 1;
}

.trash-type-list .badge {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    padding: 0.125rem 0.5rem;
    border-radius: 10px;
    font-size: 0.75rem;
}

.trash-type-list li.active .badge {
    background: rgba(255,255,255,0.2);
    color: white;
}

.trash-actions {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.trash-content {
    flex-grow: 1;
    min-width: 0;
}

.trash-overview {
    text-align: center;
    padding: 2rem;
}

.empty-trash-message {
    padding: 3rem 1rem;
}

.empty-icon {
    font-size: 4rem;
    opacity: 0.5;
    margin-bottom: 1rem;
}

.trash-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.trash-stat-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem 1rem;
    text-align: center;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s, box-shadow 0.2s;
}

.trash-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.stat-count {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.trash-item-actions {
    display: flex;
    gap: 0.5rem;
}

.text-danger {
    color: var(--danger-color, #dc3545);
}

.text-warning {
    color: var(--warning-color, #ffc107);
}

.page-description {
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.no-results {
    text-align: center;
    color: var(--text-secondary);
    padding: 2rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Restore item
    document.querySelectorAll('.restore-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const entityType = this.dataset.entityType;
            const entityId = this.dataset.entityId;
            
            if (!confirm('Restore this item from trash?')) return;
            
            try {
                const response = await fetch(`/api/trash/${entityType}/${entityId}/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cascade: true })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Remove row from table
                    this.closest('tr').remove();
                    showFlashMessage('Item restored successfully', 'success');
                    
                    // Update sidebar counts
                    updateSidebarCount(entityType, -1);
                } else {
                    showFlashMessage(result.error || 'Failed to restore item', 'error');
                }
            } catch (error) {
                showFlashMessage('Error restoring item: ' + error.message, 'error');
            }
        });
    });
    
    // Permanent delete
    document.querySelectorAll('.permanent-delete-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const entityType = this.dataset.entityType;
            const entityId = this.dataset.entityId;
            
            if (!confirm('PERMANENTLY DELETE this item? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure? This action is irreversible.')) return;
            
            try {
                const response = await fetch(`/api/trash/${entityType}/${entityId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.closest('tr').remove();
                    showFlashMessage('Item permanently deleted', 'success');
                    updateSidebarCount(entityType, -1);
                } else {
                    showFlashMessage(result.error || 'Failed to delete item', 'error');
                }
            } catch (error) {
                showFlashMessage('Error deleting item: ' + error.message, 'error');
            }
        });
    });
    
    // Cleanup expired items (admin only)
    const cleanupBtn = document.getElementById('cleanup-expired-btn');
    if (cleanupBtn) {
        cleanupBtn.addEventListener('click', async function() {
            if (!confirm('This will permanently delete all items that have been in trash for more than 30 days. Continue?')) return;
            
            try {
                const response = await fetch('/api/trash/cleanup', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showFlashMessage(`Cleanup complete. ${result.deleted_count} items permanently deleted.`, 'success');
                    // Reload page to refresh counts
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showFlashMessage(result.error || 'Cleanup failed', 'error');
                }
            } catch (error) {
                showFlashMessage('Error during cleanup: ' + error.message, 'error');
            }
        });
    }
    
    function updateSidebarCount(entityType, delta) {
        // Find the sidebar item for this entity type
        const listItems = document.querySelectorAll('.trash-type-list li');
        listItems.forEach(li => {
            const link = li.querySelector('a');
            if (link && link.href.includes(`type=${entityType}`)) {
                const badge = li.querySelector('.badge');
                if (badge) {
                    const currentCount = parseInt(badge.textContent) || 0;
                    const newCount = Math.max(0, currentCount + delta);
                    badge.textContent = newCount;
                    
                    // Hide if count is 0
                    if (newCount === 0) {
                        li.style.display = 'none';
                    }
                }
            }
        });
        
        // Update "All Types" count
        const allTypesItem = document.querySelector('.trash-type-list li:first-child .badge');
        if (allTypesItem) {
            const currentTotal = parseInt(allTypesItem.textContent) || 0;
            allTypesItem.textContent = Math.max(0, currentTotal + delta);
        }
    }
    
    function showFlashMessage(message, type) {
        // Create flash message element
        const flash = document.createElement('div');
        flash.className = `flash-message flash-${type}`;
        flash.textContent = message;
        
        // Add to page
        const container = document.querySelector('.flash-messages') || createFlashContainer();
        container.appendChild(flash);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            flash.remove();
        }, 5000);
    }
    
    function createFlashContainer() {
        const container = document.createElement('div');
        container.className = 'flash-messages';
        document.body.insertBefore(container, document.body.firstChild);
        return container;
    }
});
</script>
{% endblock %}
