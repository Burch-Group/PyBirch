{% extends "base.html" %}
{% from "macros.html" import detail_action_buttons %}

{% block title %}{{ issue.title }} - {{ equipment.name }} - PyBirch Database{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.equipment') }}">Equipment</a> / 
            <a href="{{ url_for('main.equipment_detail', equipment_id=equipment.id) }}">{{ equipment.name }}</a> / 
            <a href="{{ url_for('main.equipment_issues', equipment_id=equipment.id) }}">Issues</a> /
            #{{ issue.id }}
        </div>
    </div>
    
    <div class="detail-header">
        <div class="issue-title-row">
            <h1>{{ issue.title }}</h1>
            <span class="priority-badge priority-{{ issue.priority }}">{{ issue.priority }}</span>
        </div>
        <div class="detail-actions">
            <span class="status-badge status-{{ issue.status }}">{{ issue.status }}</span>
            {{ detail_action_buttons(
                edit_url=url_for('main.equipment_issue_edit', equipment_id=equipment.id, issue_id=issue.id),
                entity_type='equipment_issue',
                entity_id=issue.id,
                show_archive=true,
                show_trash=false
            ) }}
        </div>
    </div>
    
    <div class="issue-meta">
        <span>Reported {{ issue.created_at[:10] if issue.created_at else 'Unknown' }}</span>
        {% if issue.reporter_name %}
        <span>by {{ issue.reporter_name }}</span>
        {% endif %}
        {% if issue.assignee_name %}
        <span>â€¢ Assigned to <strong>{{ issue.assignee_name }}</strong></span>
        {% endif %}
    </div>
    
    <div class="detail-grid">
        <div class="detail-section">
            <h2>Details</h2>
            <dl class="detail-list">
                <dt>Category</dt>
                <dd>{{ issue.category }}</dd>
                
                <dt>Equipment</dt>
                <dd><a href="{{ url_for('main.equipment_detail', equipment_id=equipment.id) }}">{{ equipment.name }}</a></dd>
                
                <dt>Status</dt>
                <dd><span class="status-badge status-{{ issue.status }}">{{ issue.status }}</span></dd>
                
                <dt>Priority</dt>
                <dd><span class="priority-badge priority-{{ issue.priority }}">{{ issue.priority }}</span></dd>
                
                {% if issue.resolved_at %}
                <dt>Resolved</dt>
                <dd>{{ issue.resolved_at[:10] }}</dd>
                {% endif %}
            </dl>
        </div>
        
        <div class="detail-section">
            <h2>Costs & Downtime</h2>
            <dl class="detail-list">
                <dt>Repair Cost</dt>
                <dd>{% if issue.cost %}${{ "%.2f"|format(issue.cost) }}{% else %}-{% endif %}</dd>
                
                <dt>Downtime</dt>
                <dd>{% if issue.downtime_hours %}{{ issue.downtime_hours }} hours{% else %}-{% endif %}</dd>
                
                <dt>Created</dt>
                <dd>{{ issue.created_at[:16] if issue.created_at else '-' }}</dd>
                
                <dt>Last Updated</dt>
                <dd>{{ issue.updated_at[:16] if issue.updated_at else '-' }}</dd>
            </dl>
        </div>
    </div>
    
    {% if issue.description %}
    <div class="detail-section full-width">
        <h2>Description</h2>
        <div class="text-content">
            {{ issue.description | nl2br | safe }}
        </div>
    </div>
    {% endif %}
    
    {% if issue.error_message %}
    <div class="detail-section full-width">
        <h2>Error Message</h2>
        <pre class="error-display">{{ issue.error_message }}</pre>
    </div>
    {% endif %}
    
    {% if issue.steps_to_reproduce %}
    <div class="detail-section full-width">
        <h2>Steps to Reproduce</h2>
        <div class="text-content">
            {{ issue.steps_to_reproduce | nl2br | safe }}
        </div>
    </div>
    {% endif %}
    
    {% if issue.resolution %}
    <div class="detail-section full-width resolution-section">
        <h2>Resolution</h2>
        <div class="text-content">
            {{ issue.resolution | nl2br | safe }}
        </div>
    </div>
    {% endif %}
    
    <!-- Update Status Section -->
    {% if current_user %}
    <div class="detail-section full-width">
        <h2>Update Status</h2>
        <form action="{{ url_for('main.equipment_issue_update_status', equipment_id=equipment.id, issue_id=issue.id) }}" method="POST" class="status-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="open" {% if issue.status == 'open' %}selected{% endif %}>Open</option>
                        <option value="in_progress" {% if issue.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="resolved" {% if issue.status == 'resolved' %}selected{% endif %}>Resolved</option>
                        <option value="closed" {% if issue.status == 'closed' %}selected{% endif %}>Closed</option>
                        <option value="wont_fix" {% if issue.status == 'wont_fix' %}selected{% endif %}>Won't Fix</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assignee_id">Assignee</label>
                    <select id="assignee_id" name="assignee_id">
                        <option value="">-- Unassigned --</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if issue.assignee_id == user.id %}selected{% endif %}>{{ user.name or user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="resolution">Resolution Notes</label>
                <textarea id="resolution" name="resolution" rows="3">{{ issue.resolution or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Update Status</button>
        </form>
    </div>
    {% endif %}
    
    <!-- Images Section -->
    {% include 'partials/image_gallery.html' %}
</div>

<style>
.issue-title-row {
    display: flex;
    align-items: center;
    gap: 1rem;
}
.issue-title-row h1 {
    margin: 0;
}
.issue-meta {
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
}
.issue-meta span {
    margin-right: 0.25rem;
}
.detail-section.full-width {
    grid-column: 1 / -1;
}
.priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}
.priority-low { background: #e3f2fd; color: #1565c0; }
.priority-medium { background: #fff3e0; color: #e65100; }
.priority-high { background: #ffebee; color: #c62828; }
.priority-critical { background: #c62828; color: white; }

.text-content {
    line-height: 1.6;
    white-space: pre-wrap;
}
.error-display {
    background: #ffebee;
    color: #c62828;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    font-family: monospace;
    font-size: 0.9rem;
}
.resolution-section {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%) !important;
    border: 1px solid #81c784;
}
.resolution-section h2 {
    color: #2e7d32 !important;
}

/* Status form */
.status-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}
@media (max-width: 600px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.form-group label {
    font-weight: 500;
    font-size: 0.9rem;
}
.form-group select,
.form-group textarea {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color, #ddd);
    border-radius: 4px;
    font-size: 1rem;
    background: var(--input-bg, #fff);
    color: var(--text-primary);
}
.form-group textarea {
    resize: vertical;
}
</style>
{% endblock %}
