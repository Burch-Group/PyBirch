{% extends "base.html" %}

{% block title %}Start Run - {{ procedure.name }} - PyBirch Database{% endblock %}

{% block content %}
<div class="form-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.procedures') }}">Procedures</a> / 
            <a href="{{ url_for('main.procedure_detail', procedure_id=procedure.id) }}">{{ procedure.name }}</a> / 
            Start Run
        </div>
    </div>

    <div class="form-container">
        <h1>‚ñ∂Ô∏è Start Fabrication Run</h1>
        <p class="form-subtitle">Procedure: <strong>{{ procedure.name }}</strong> {% if procedure.procedure_type %}({{ procedure.procedure_type }}){% endif %} v{{ procedure.version }}</p>
        
        <form method="POST" class="entity-form">
            <div class="form-section">
                <h2>üß¨ Select Samples</h2>
                <p class="section-help">Select one or more samples to apply this procedure to. A separate fabrication run will be created for each selected sample.</p>
                
                <div class="sample-selector">
                    <div class="selector-controls">
                        <button type="button" class="btn btn-small btn-secondary" onclick="selectAllSamples()">Select All</button>
                        <button type="button" class="btn btn-small btn-secondary" onclick="deselectAllSamples()">Deselect All</button>
                        <input type="text" id="sample-search" placeholder="Filter samples..." onkeyup="filterSamples()">
                    </div>
                    
                    <div class="sample-list" id="sample-list">
                        {% for sample in samples %}
                        <label class="sample-checkbox">
                            <input type="checkbox" name="sample_ids" value="{{ sample.id }}">
                            <span class="sample-info">
                                <strong>{{ sample.sample_id }}</strong>
                                {% if sample.name %} - {{ sample.name }}{% endif %}
                                {% if sample.material %}<span class="sample-material">({{ sample.material }})</span>{% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    
                    <div class="selected-count">
                        <span id="selected-count">0</span> sample(s) selected
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h2>‚öóÔ∏è Run Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" name="status" class="searchable-select" required data-current-value="in_progress">
                            <option value="pending">Pending</option>
                            <option value="in_progress" selected>In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="created_by">Operator</label>
                        <input type="text" id="created_by" name="created_by" 
                               value="{{ g.current_user.username if g.current_user else '' }}"
                               placeholder="Person performing this run">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="started_at">Started At</label>
                        <input type="datetime-local" id="started_at" name="started_at" value="{{ now }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="run_number">Run Number</label>
                        <input type="number" id="run_number" name="run_number" min="1"
                               placeholder="Optional batch/run number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="4" 
                              placeholder="Any observations or notes about this run..."></textarea>
                </div>
            </div>
            
            <!-- Procedure Parameters Section -->
            {% if procedure.parameters and procedure.parameters|length > 0 %}
            <div class="form-section" id="procedure-params-section">
                <h2>‚öôÔ∏è Procedure Parameters</h2>
                <p class="form-help">Default parameters for this procedure. Modify values as needed for this run.</p>
                <div id="procedure-params-container">
                    {% for param in procedure.parameters %}
                    <div class="param-row">
                        <label>{{ param.name }}</label>
                        {% if param.type == 'select' and param.options %}
                        <select name="proc_param[{{ param.name }}]" class="param-input">
                            {% for opt in param.options %}
                            <option value="{{ opt }}" {% if opt == param.default %}selected{% endif %}>{{ opt }}</option>
                            {% endfor %}
                        </select>
                        {% elif param.type == 'checkbox' %}
                        <input type="checkbox" name="proc_param[{{ param.name }}]" class="param-input" value="true"
                               {% if param.default == true or param.default == 'true' %}checked{% endif %}>
                        {% elif param.type == 'number' %}
                        <input type="number" name="proc_param[{{ param.name }}]" class="param-input" 
                               value="{{ param.default }}" step="any">
                        {% else %}
                        <input type="text" name="proc_param[{{ param.name }}]" class="param-input" 
                               value="{{ param.default }}">
                        {% endif %}
                        {% if param.unit %}<span class="param-unit">{{ param.unit }}</span>{% endif %}
                        {% if param.default is defined %}<span class="param-default">(default: {{ param.default }}{% if param.unit %} {{ param.unit }}{% endif %})</span>{% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Step Parameters Section -->
            {% set ns = namespace(has_step_params=false) %}
            {% for step in procedure.steps or [] %}
                {% if step.parameters and step.parameters|length > 0 %}
                    {% set ns.has_step_params = true %}
                {% endif %}
            {% endfor %}
            {% if ns.has_step_params %}
            <div class="form-section" id="step-params-section">
                <h2>üìã Step Parameters</h2>
                <p class="form-help">Parameters for each step in the procedure. Modify values as needed.</p>
                <div id="step-params-container">
                    {% for step in procedure.steps or [] %}
                    {% set step_idx = loop.index0 %}
                    {% if step.parameters and step.parameters|length > 0 %}
                    <div class="step-params-group">
                        <div class="step-params-header">
                            Step {{ loop.index }}: {{ step.name or 'Unnamed Step' }}
                        </div>
                        <div class="step-params-body">
                            {% for param in step.parameters %}
                            <div class="param-row">
                                <label>{{ param.name }}</label>
                                {% if param.type == 'select' and param.options %}
                                <select name="step_param[{{ step_idx }}][{{ param.name }}]" class="param-input">
                                    {% for opt in param.options %}
                                    <option value="{{ opt }}" {% if opt == param.default %}selected{% endif %}>{{ opt }}</option>
                                    {% endfor %}
                                </select>
                                {% elif param.type == 'checkbox' %}
                                <input type="checkbox" name="step_param[{{ step_idx }}][{{ param.name }}]" class="param-input" value="true"
                                       {% if param.default == true or param.default == 'true' %}checked{% endif %}>
                                {% elif param.type == 'number' %}
                                <input type="number" name="step_param[{{ step_idx }}][{{ param.name }}]" class="param-input" 
                                       value="{{ param.default }}" step="any">
                                {% else %}
                                <input type="text" name="step_param[{{ step_idx }}][{{ param.name }}]" class="param-input" 
                                       value="{{ param.default }}">
                                {% endif %}
                                {% if param.unit %}<span class="param-unit">{{ param.unit }}</span>{% endif %}
                                {% if param.default is defined %}<span class="param-default">(default: {{ param.default }}{% if param.unit %} {{ param.unit }}{% endif %})</span>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div class="form-actions">
                <a href="{{ url_for('main.procedure_detail', procedure_id=procedure.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Start Fabrication Run</button>
            </div>
        </form>
    </div>
</div>

<style>
.form-subtitle {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
}

.section-help {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.sample-selector {
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    padding: 1rem;
}

.selector-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.selector-controls input[type="text"] {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg-primary);
}

.sample-list {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg-primary);
}

.sample-checkbox {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    cursor: pointer;
    transition: background-color 0.15s;
}

.sample-checkbox:last-child {
    border-bottom: none;
}

.sample-checkbox:hover {
    background: var(--color-bg-secondary);
}

.sample-checkbox input[type="checkbox"] {
    margin-right: 0.75rem;
    width: 18px;
    height: 18px;
}

.sample-info {
    flex: 1;
}

.sample-material {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
}

.selected-count {
    margin-top: 1rem;
    padding: 0.5rem;
    background: var(--color-bg-primary);
    border-radius: 4px;
    text-align: center;
    font-weight: 500;
}

.sample-checkbox.hidden {
    display: none;
}

/* Parameter styles */
.form-help {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.param-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: var(--color-bg-tertiary, #f8f9fa);
    border-radius: 6px;
}

.param-row label {
    min-width: 150px;
    font-weight: 500;
    margin: 0;
}

.param-row .param-input {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg-primary);
}

.param-row input[type="checkbox"].param-input {
    flex: none;
    width: 18px;
    height: 18px;
    padding: 0;
}

.param-row .param-unit {
    color: var(--color-text-secondary, #666);
    font-size: 0.9rem;
    min-width: 50px;
}

.param-row .param-default {
    color: var(--color-text-muted, #999);
    font-size: 0.85rem;
}

.step-params-group {
    margin-bottom: 1.5rem;
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 8px;
    overflow: hidden;
}

.step-params-header {
    background: var(--color-bg-secondary, #f0f0f0);
    padding: 0.75rem 1rem;
    font-weight: 600;
    border-bottom: 1px solid var(--color-border, #e0e0e0);
}

.step-params-body {
    padding: 1rem;
}
</style>

<script>
function selectAllSamples() {
    document.querySelectorAll('#sample-list input[type="checkbox"]').forEach(cb => {
        if (!cb.closest('.sample-checkbox').classList.contains('hidden')) {
            cb.checked = true;
        }
    });
    updateSelectedCount();
}

function deselectAllSamples() {
    document.querySelectorAll('#sample-list input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    updateSelectedCount();
}

function filterSamples() {
    const search = document.getElementById('sample-search').value.toLowerCase();
    document.querySelectorAll('.sample-checkbox').forEach(label => {
        const text = label.textContent.toLowerCase();
        if (text.includes(search)) {
            label.classList.remove('hidden');
        } else {
            label.classList.add('hidden');
        }
    });
}

function updateSelectedCount() {
    const count = document.querySelectorAll('#sample-list input[type="checkbox"]:checked').length;
    document.getElementById('selected-count').textContent = count;
}

// Update count when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#sample-list input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
});
</script>
{% endblock %}
