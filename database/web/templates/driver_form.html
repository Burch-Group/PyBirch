{% extends "base.html" %}

{% block title %}{{ form_title }} - PyBirch Database{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }
    .form-section {
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .form-section h3 {
        margin-top: 0;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #e2e8f0;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 500;
        color: #374151;
    }
    .form-group label .required {
        color: #dc2626;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-group .help-text {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
    }
    .code-editor-section {
        grid-column: 1 / -1;
    }
    .code-editor-container {
        border: 1px solid #d1d5db;
        border-radius: 6px;
        overflow: hidden;
    }
    .CodeMirror {
        height: 400px;
        font-family: 'Courier New', Consolas, monospace;
        font-size: 14px;
    }
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #e2e8f0;
    }
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
        width: auto;
    }
    .validation-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        margin-bottom: 12px;
    }
    .validation-status.valid {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }
    .validation-status.invalid {
        background: rgba(239, 68, 68, 0.1);
        color: #dc2626;
    }
    .validation-status.pending {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }
    .readonly-field {
        background: #f3f4f6;
        color: #6b7280;
        cursor: not-allowed;
    }
    .readonly-field:focus {
        border-color: #d1d5db;
        box-shadow: none;
    }
    .detected-value {
        font-weight: 600;
        color: #059669;
    }
    /* Upload mode toggle */
    .upload-mode-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    .upload-mode-toggle .btn {
        flex: 1;
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upload-mode-toggle .btn.active {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
        color: #2563eb;
    }
    .upload-mode-toggle .btn:hover:not(.active) {
        border-color: #94a3b8;
    }
    /* Folder upload section */
    .folder-upload-area {
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        padding: 32px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .folder-upload-area:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.02);
    }
    .folder-upload-area.uploading {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }
    .folder-upload-area.success {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }
    .folder-upload-area i {
        font-size: 48px;
        color: #9ca3af;
        margin-bottom: 12px;
    }
    .folder-upload-area.uploading i,
    .folder-upload-area.success i {
        color: #3b82f6;
    }
    .naming-convention {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
    }
    .naming-convention h4 {
        margin: 0 0 8px 0;
        color: #0369a1;
        font-size: 0.9rem;
    }
    .naming-convention code {
        background: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85rem;
    }
    .uploaded-files-list {
        text-align: left;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 16px;
    }
    .file-tree {
        font-family: monospace;
        font-size: 0.9rem;
    }
    .file-tree-item {
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .file-tree-item.main-file {
        background: rgba(16, 185, 129, 0.1);
        border-radius: 4px;
    }
    .file-tree-item .badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        background: #10b981;
        color: white;
    }
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="breadcrumb">
        <a href="{{ url_for('main.drivers') }}">Drivers</a> / {{ form_title }}
    </div>
    
    <h1>{{ form_title }}</h1>
    
    <form method="POST" action="{{ form_action }}" id="driver-form">
        <div class="form-grid">
            <!-- Source Code / Folder Upload Section -->
            <div class="form-section code-editor-section">
                <h3>Driver Source <span class="required">*</span></h3>
                
                <!-- Upload Mode Toggle -->
                <div class="upload-mode-toggle">
                    <button type="button" class="btn active" id="mode-paste" onclick="setUploadMode('paste')">
                        üìù Paste Code
                    </button>
                    <button type="button" class="btn" id="mode-folder" onclick="setUploadMode('folder')">
                        üìÅ Upload Folder
                    </button>
                </div>
                
                <!-- Paste Code Mode -->
                <div id="paste-mode-section">
                    <p class="help-text" style="margin-top: 0; margin-bottom: 12px;">Paste your Python driver class below. Class name, base class, and type will be auto-detected.</p>
                    
                    <div id="validation-status" class="validation-status pending">
                        <span>‚è≥</span> Paste code to auto-detect class info
                    </div>
                    
                    <div class="code-editor-container">
                        <textarea name="source_code" id="source-code">{{ driver.source_code or '' }}</textarea>
                    </div>
                    
                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-secondary" onclick="validateCode()">Validate Syntax</button>
                    </div>
                </div>
                
                <!-- Folder Upload Mode -->
                <div id="folder-mode-section" class="hidden">
                    <div class="naming-convention">
                        <h4>üìã File Naming Convention</h4>
                        <p style="margin: 0;">The main driver file must be named:</p>
                        <ul style="margin: 8px 0 0 0; padding-left: 24px;">
                            <li><code>driver.py</code> (preferred)</li>
                            <li><code>&lt;ClassName&gt;_driver.py</code> (e.g., <code>MyLockIn_driver.py</code>)</li>
                        </ul>
                    </div>
                    
                    <div class="folder-upload-area" id="folder-upload-area" onclick="document.getElementById('folder-input').click()">
                        <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;" onchange="handleFolderUpload(this)">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìÅ</div>
                        <p style="margin: 0; color: #374151; font-weight: 500;">Click to select a folder</p>
                        <p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.9rem;">or drag and drop a folder here</p>
                    </div>
                    
                    <div id="uploaded-files-container" class="uploaded-files-list hidden">
                        <h4 style="margin: 0 0 8px 0;">Uploaded Files:</h4>
                        <div id="file-tree" class="file-tree"></div>
                    </div>
                    
                    <div id="folder-validation-status" class="validation-status pending hidden">
                        <span>‚è≥</span> Upload a folder to detect driver info
                    </div>
                </div>
                
                <!-- Hidden fields for folder upload data -->
                <input type="hidden" name="upload_id" id="upload-id" value="">
                <input type="hidden" name="driver_files_json" id="driver-files-json" value="">
                <input type="hidden" name="main_file_path" id="main-file-path" value="">
                <input type="hidden" name="has_folder_upload" id="has-folder-upload" value="false">
            </div>
            
            <!-- Auto-detected Info (read-only) -->
            <div class="form-section">
                <h3>Detected from Code</h3>
                
                <div class="form-group">
                    <label>Class Name</label>
                    <input type="text" name="name" id="detected-class-name" value="{{ driver.name or '' }}" 
                           readonly class="readonly-field"
                           placeholder="(auto-detected from code)">
                    <div class="help-text">Extracted from class definition</div>
                </div>
                
                <div class="form-group">
                    <label>Base Class</label>
                    <input type="text" name="base_class" id="detected-base-class" value="{{ driver.base_class or '' }}" 
                           readonly class="readonly-field"
                           placeholder="(auto-detected from code)">
                    <div class="help-text">Parent class this driver extends</div>
                </div>
                
                <div class="form-group">
                    <label>Instrument Type</label>
                    <input type="text" name="instrument_type" id="detected-instrument-type" value="{{ driver.instrument_type or '' }}" 
                           readonly class="readonly-field"
                           placeholder="(auto-detected from base class)">
                    <div class="help-text">Determined from base class inheritance</div>
                </div>
            </div>
            
            <!-- User-provided Info -->
            <div class="form-section">
                <h3>Additional Information</h3>
                
                <div class="form-group">
                    <label>Display Name <span class="required">*</span></label>
                    <input type="text" name="display_name" id="display-name" value="{{ driver.display_name or '' }}" required
                           placeholder="e.g., My Lock-In Amplifier">
                    <div class="help-text">Human-readable name (auto-suggested from class name)</div>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Brief description of this instrument...">{{ driver.description or '' }}</textarea>
                </div>
            </div>
            
            <!-- Classification -->
            <div class="form-section">
                <h3>Classification</h3>
                
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" name="category" value="{{ driver.category or '' }}"
                           placeholder="e.g., Lock-In Amplifier, Spectrometer, Stage">
                </div>
                
                <div class="form-group">
                    <label>Manufacturer</label>
                    <input type="text" name="manufacturer" value="{{ driver.manufacturer or '' }}"
                           placeholder="e.g., Stanford Research, Thorlabs">
                </div>
                
                <div class="form-group">
                    <label>Dependencies</label>
                    <textarea name="dependencies" rows="2" placeholder="Comma-separated list of required packages">{{ driver.dependencies or '' }}</textarea>
                    <div class="help-text">e.g., pyvisa, numpy, scipy</div>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="operational" {% if driver.status == 'operational' or not driver.status %}selected{% endif %}>Operational</option>
                        <option value="development" {% if driver.status == 'development' %}selected{% endif %}>Development</option>
                        <option value="testing" {% if driver.status == 'testing' %}selected{% endif %}>Testing</option>
                        <option value="experimental" {% if driver.status == 'experimental' %}selected{% endif %}>Experimental</option>
                        <option value="deprecated" {% if driver.status == 'deprecated' %}selected{% endif %}>Deprecated</option>
                    </select>
                    <div class="help-text">Current development/deployment status</div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" name="is_public" id="is_public" {% if driver.is_public %}checked{% endif %}>
                        <label for="is_public">Make publicly available</label>
                    </div>
                    <div class="help-text">Allow other labs to use this driver</div>
                </div>
                
                {% if driver.id %}
                <div class="form-group">
                    <label>Change Summary</label>
                    <input type="text" name="change_summary" placeholder="Brief description of changes...">
                    <div class="help-text">This will be recorded in the version history</div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('main.drivers') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Driver</button>
        </div>
    </form>
</div>

<script>
    // Upload mode state
    let currentMode = 'paste';
    
    // Known base classes that map to instrument types
    const BASE_CLASS_TYPES = {
        'Measurement': 'measurement',
        'Movement': 'movement',
        'MeasurementInstrument': 'measurement',
        'MovementInstrument': 'movement',
        'Instrument': 'measurement',  // default
    };
    
    // Upload mode switching
    function setUploadMode(mode) {
        currentMode = mode;
        document.getElementById('mode-paste').classList.toggle('active', mode === 'paste');
        document.getElementById('mode-folder').classList.toggle('active', mode === 'folder');
        document.getElementById('paste-mode-section').classList.toggle('hidden', mode !== 'paste');
        document.getElementById('folder-mode-section').classList.toggle('hidden', mode !== 'folder');
        document.getElementById('has-folder-upload').value = (mode === 'folder') ? 'true' : 'false';
        
        // Clear source code if switching to folder mode
        if (mode === 'folder') {
            // Keep editor content but don't require it for validation
        }
    }
    
    // Handle folder upload
    async function handleFolderUpload(input) {
        const files = input.files;
        if (!files || files.length === 0) return;
        
        const uploadArea = document.getElementById('folder-upload-area');
        uploadArea.classList.add('uploading');
        uploadArea.innerHTML = '<div style="font-size: 48px; margin-bottom: 12px;">‚è≥</div><p style="margin: 0;">Uploading files...</p>';
        
        // Create FormData with all files
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            formData.append('files', file, file.webkitRelativePath || file.name);
        }
        
        try {
            const response = await fetch('/api/v1/drivers/upload-folder', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                uploadArea.classList.remove('uploading');
                uploadArea.classList.add('success');
                uploadArea.innerHTML = '<div style="font-size: 48px; margin-bottom: 12px;">‚úÖ</div><p style="margin: 0; color: #059669;">Folder uploaded successfully!</p><p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.9rem;">Click to select a different folder</p>';
                
                // Store upload data
                document.getElementById('upload-id').value = result.upload_id;
                document.getElementById('driver-files-json').value = JSON.stringify(result.files);
                document.getElementById('main-file-path').value = result.main_file || '';
                
                // Display file tree
                displayFileTree(result.files, result.main_file);
                
                // Update source code textarea with main file content
                if (result.main_file_content) {
                    editor.setValue(result.main_file_content);
                    document.getElementById('source-code').value = result.main_file_content;
                    updateDetectedFields();
                }
                
                // Update validation status
                const validationEl = document.getElementById('folder-validation-status');
                validationEl.classList.remove('hidden');
                if (result.main_file) {
                    validationEl.className = 'validation-status valid';
                    validationEl.innerHTML = '<span>‚úì</span> Main driver file detected: ' + result.main_file;
                } else {
                    validationEl.className = 'validation-status invalid';
                    validationEl.innerHTML = '<span>‚ö†Ô∏è</span> No main driver file found. Please ensure you have a driver.py or &lt;ClassName&gt;_driver.py file.';
                }
            } else {
                throw new Error(result.error || 'Upload failed');
            }
        } catch (error) {
            uploadArea.classList.remove('uploading');
            uploadArea.innerHTML = '<div style="font-size: 48px; margin-bottom: 12px;">‚ùå</div><p style="margin: 0; color: #dc2626;">Upload failed: ' + error.message + '</p><p style="margin: 4px 0 0 0; color: #6b7280; font-size: 0.9rem;">Click to try again</p>';
        }
    }
    
    // Display uploaded file tree
    function displayFileTree(files, mainFile) {
        const container = document.getElementById('uploaded-files-container');
        const treeEl = document.getElementById('file-tree');
        container.classList.remove('hidden');
        
        // Sort files by path
        files.sort((a, b) => a.path.localeCompare(b.path));
        
        let html = '';
        for (const file of files) {
            const isMain = file.path === mainFile;
            const icon = file.path.endsWith('/') ? 'üìÅ' : (file.path.endsWith('.py') ? 'üêç' : 'üìÑ');
            const indent = (file.path.split('/').length - 1) * 16;
            const fileName = file.path.split('/').pop();
            
            html += '<div class="file-tree-item' + (isMain ? ' main-file' : '') + '" style="padding-left: ' + indent + 'px;">';
            html += '<span>' + icon + '</span>';
            html += '<span>' + fileName + '</span>';
            if (isMain) {
                html += '<span class="badge">Main Driver</span>';
            }
            if (file.size) {
                html += '<span style="color: #9ca3af; font-size: 0.8rem; margin-left: auto;">' + formatFileSize(file.size) + '</span>';
            }
            html += '</div>';
        }
        
        treeEl.innerHTML = html;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    // Drag and drop support
    const folderArea = document.getElementById('folder-upload-area');
    if (folderArea) {
        folderArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            folderArea.style.borderColor = '#3b82f6';
            folderArea.style.background = 'rgba(59, 130, 246, 0.05)';
        });
        folderArea.addEventListener('dragleave', () => {
            folderArea.style.borderColor = '';
            folderArea.style.background = '';
        });
        folderArea.addEventListener('drop', (e) => {
            e.preventDefault();
            folderArea.style.borderColor = '';
            folderArea.style.background = '';
            // Note: Folder drop is complex and may not work in all browsers
            // For now, prompt user to use the click method
            alert('Please click to select a folder. Drag and drop for folders has limited browser support.');
        });
    }
    
    // Initialize CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById('source-code'), {
        mode: 'python',
        theme: 'material-darker',
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        matchBrackets: true,
        autoCloseBrackets: true,
    });
    
    // Extract class info from Python source code
    function extractClassInfo(code) {
        // Match class definition: class ClassName(BaseClass):  or  class ClassName(module.BaseClass):
        const classPattern = /^class\s+([A-Za-z_][A-Za-z0-9_]*)\s*\(\s*([^)]+)\s*\)\s*:/m;
        const match = code.match(classPattern);
        
        if (match) {
            const className = match[1];
            let baseClass = match[2].trim();
            
            // Handle multiple inheritance - take first base
            if (baseClass.includes(',')) {
                baseClass = baseClass.split(',')[0].trim();
            }
            
            // Handle module-qualified names like pybirch.Measurement
            if (baseClass.includes('.')) {
                baseClass = baseClass.split('.').pop();
            }
            
            // Determine instrument type from base class
            let instrumentType = BASE_CLASS_TYPES[baseClass] || '';
            
            // If not directly found, check if any known base class is a substring
            if (!instrumentType) {
                for (const [known, type] of Object.entries(BASE_CLASS_TYPES)) {
                    if (baseClass.toLowerCase().includes(known.toLowerCase())) {
                        instrumentType = type;
                        break;
                    }
                }
            }
            
            return { className, baseClass, instrumentType };
        }
        return null;
    }
    
    // Convert CamelCase to human-readable
    function camelToDisplay(str) {
        return str
            .replace(/([A-Z])/g, ' $1')  // Add space before capitals
            .replace(/^./, s => s.toUpperCase())  // Capitalize first
            .trim();
    }
    
    // Update detected fields from code
    function updateDetectedFields() {
        const code = editor.getValue();
        const info = extractClassInfo(code);
        
        const classField = document.getElementById('detected-class-name');
        const baseField = document.getElementById('detected-base-class');
        const typeField = document.getElementById('detected-instrument-type');
        const displayField = document.getElementById('display-name');
        
        if (info) {
            classField.value = info.className;
            classField.classList.add('detected-value');
            
            baseField.value = info.baseClass;
            baseField.classList.add('detected-value');
            
            typeField.value = info.instrumentType;
            typeField.classList.add('detected-value');
            
            // Auto-suggest display name if empty
            if (!displayField.value) {
                displayField.value = camelToDisplay(info.className);
            }
            
            updateValidationStatus('valid', '‚úì', 
                `Detected: ${info.className} extends ${info.baseClass} (${info.instrumentType || 'unknown type'})`);
        } else {
            // Clear fields if no class found
            if (!classField.dataset.original) {
                classField.value = '';
                classField.classList.remove('detected-value');
            }
            if (!baseField.dataset.original) {
                baseField.value = '';
                baseField.classList.remove('detected-value');
            }
            if (!typeField.dataset.original) {
                typeField.value = '';
                typeField.classList.remove('detected-value');
            }
            
            if (code.trim()) {
                updateValidationStatus('pending', '‚ö†Ô∏è', 'No class definition found. Expected: class ClassName(BaseClass):');
            } else {
                updateValidationStatus('pending', '‚è≥', 'Paste code to auto-detect class info');
            }
        }
    }
    
    // Debounce function to avoid too frequent updates
    let debounceTimer;
    function debounce(func, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(func, delay);
    }
    
    // Update hidden textarea and detect class info when editor changes
    editor.on('change', function() {
        document.getElementById('source-code').value = editor.getValue();
        debounce(updateDetectedFields, 300);
    });
    
    function updateValidationStatus(status, icon, message) {
        const el = document.getElementById('validation-status');
        el.className = 'validation-status ' + status;
        el.innerHTML = '<span>' + icon + '</span> ' + message;
    }
    
    async function validateCode() {
        const code = editor.getValue();
        updateValidationStatus('pending', '‚è≥', 'Validating...');
        
        try {
            const response = await fetch('/api/v1/drivers/validate-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_code: code,
                    base_class: document.getElementById('detected-base-class').value
                })
            });
            
            const result = await response.json();
            
            if (result.data && result.data.valid) {
                let message = '‚úì Syntax is valid';
                if (result.data.class_name) {
                    message += ' - Found class: ' + result.data.class_name;
                }
                if (result.data.warnings && result.data.warnings.length > 0) {
                    message += ' (with warnings)';
                }
                updateValidationStatus('valid', '‚úì', message);
            } else {
                let errorMsg = 'Syntax errors found';
                if (result.data && result.data.errors && result.data.errors.length > 0) {
                    const err = result.data.errors[0];
                    errorMsg = err.message;
                    if (err.line) {
                        errorMsg += ' (line ' + err.line + ')';
                        // Highlight the error line
                        editor.setCursor(err.line - 1, err.offset || 0);
                        editor.focus();
                    }
                }
                updateValidationStatus('invalid', '‚úó', errorMsg);
            }
        } catch (error) {
            updateValidationStatus('invalid', '‚úó', 'Validation failed: ' + error.message);
        }
    }
    
    // Validate on form submit
    document.getElementById('driver-form').addEventListener('submit', function(e) {
        // Update textarea before submit
        document.getElementById('source-code').value = editor.getValue();
        
        // Ensure detected fields are populated
        const className = document.getElementById('detected-class-name').value;
        const baseClass = document.getElementById('detected-base-class').value;
        
        // For folder upload mode, check that a folder was uploaded
        if (currentMode === 'folder') {
            const uploadId = document.getElementById('upload-id').value;
            const mainFilePath = document.getElementById('main-file-path').value;
            
            if (!uploadId) {
                e.preventDefault();
                alert('Please upload a folder containing your driver files.');
                return false;
            }
            
            if (!mainFilePath) {
                e.preventDefault();
                alert('No main driver file found. Please ensure your folder contains driver.py or <ClassName>_driver.py');
                return false;
            }
        }
        
        if (!className || !baseClass) {
            e.preventDefault();
            alert('Please paste valid Python driver code with a class definition.');
            return false;
        }
    });
    
    // Initial detection if editing existing driver
    {% if driver.source_code %}
    setTimeout(updateDetectedFields, 100);
    {% endif %}
</script>
{% endblock %}
