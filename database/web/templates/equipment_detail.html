{% extends "base.html" %}
{% from "macros.html" import detail_action_buttons, icon_unlink, icon_plus %}

{% block title %}{{ equipment.name }} - PyBirch Database{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.equipment') }}">Equipment</a> / {{ equipment.name }}
        </div>
    </div>
    
    <div class="detail-header">
        <h1>{{ equipment.name }}</h1>
        <div class="detail-actions">
            <span class="status-badge status-{{ equipment.status }}">{{ equipment.status }}</span>
            {% set scheduling_enabled = scheduling_config.scheduling_enabled if scheduling_config else true %}
            {% if scheduling_enabled %}
            <a href="{{ url_for('main.equipment_schedule', equipment_id=equipment.id) }}" class="btn btn-primary">ðŸ“… Schedule</a>
            {% if g.current_user %}
            <a href="{{ url_for('main.equipment_book', equipment_id=equipment.id) }}" class="btn btn-success">Book Equipment</a>
            {% endif %}
            {% else %}
            <span class="status-badge" style="background: var(--color-text-secondary); color: white;">ðŸ“… Scheduling Disabled</span>
            {% endif %}
            {% if g.current_user and (equipment.owner_id == g.current_user.id or g.current_user.role == 'admin') %}
            <form action="{{ url_for('main.equipment_toggle_scheduling', equipment_id=equipment.id) }}" method="POST" style="display: inline;">
                {% if scheduling_enabled %}
                <button type="submit" class="btn btn-secondary btn-sm" title="Disable scheduling for this equipment">ðŸš« Disable Scheduling</button>
                {% else %}
                <button type="submit" class="btn btn-success btn-sm" title="Enable scheduling for this equipment">âœ… Enable Scheduling</button>
                {% endif %}
            </form>
            {% endif %}
            {{ detail_action_buttons(
                edit_url=url_for('main.equipment_edit', equipment_id=equipment.id),
                issues_url=url_for('main.equipment_issues', equipment_id=equipment.id),
                duplicate_url=url_for('main.equipment_duplicate', equipment_id=equipment.id),
                entity_type='equipment',
                entity_id=equipment.id
            ) }}
        </div>
    </div>
    
    <!-- QR Code Section -->
    <div class="qr-code-section">
        <div class="qr-code-preview">
            <img src="{{ url_for('main.equipment_qrcode_preview', equipment_id=equipment.id) }}" 
                 alt="QR Code for {{ equipment.name }}" 
                 class="qr-code-img">
        </div>
        <a href="{{ url_for('main.equipment_qrcode', equipment_id=equipment.id) }}" 
           class="btn btn-secondary btn-small" download>
            ðŸ“¥ Download QR Code
        </a>
    </div>
    
    <div class="detail-grid">
        <div class="detail-section">
            <h2>Basic Information</h2>
            <dl class="detail-list">
                <dt>Description</dt>
                <dd>{{ equipment.description or '-' }}</dd>
                
                <dt>Type</dt>
                <dd>{{ equipment.equipment_type or '-' }}</dd>
                
                <dt>Custodian</dt>
                <dd>{{ equipment.owner_name or 'Not assigned' }}</dd>
                
                <dt>Manufacturer</dt>
                <dd>{{ equipment.manufacturer or '-' }}</dd>
                
                <dt>Model</dt>
                <dd>{{ equipment.model or '-' }}</dd>
                
                <dt>Serial Number</dt>
                <dd>{{ equipment.serial_number or '-' }}</dd>
                
                <dt>Lab</dt>
                <dd>
                    {% if equipment.lab %}
                    <a href="{{ url_for('main.lab_detail', lab_id=equipment.lab.id) }}">{{ equipment.lab.name }}</a>
                    {% else %}
                    -
                    {% endif %}
                </dd>
                
                <dt>Location</dt>
                <dd>{{ equipment.location or '-' }}{% if equipment.room %} (Room {{ equipment.room }}){% endif %}</dd>
                
                {% if equipment.documentation_url %}
                <dt>Documentation</dt>
                <dd><a href="{{ equipment.documentation_url }}" target="_blank">ðŸ“„ View Documentation</a></dd>
                {% endif %}
            </dl>
        </div>
        
        <div class="detail-section">
            <h2>Purchase & Warranty</h2>
            <dl class="detail-list">
                <dt>Purchase Date</dt>
                <dd>{{ equipment.purchase_date or '-' }}</dd>
                
                <dt>Warranty Expiration</dt>
                <dd>
                    {{ equipment.warranty_expiration or '-' }}
                    {% if equipment.warranty_expiration %}
                        {% set today = None %}
                        {% if equipment.warranty_expiration < (equipment.created_at[:10] if equipment.created_at else '') %}
                        <span class="status-badge status-retired">Expired</span>
                        {% endif %}
                    {% endif %}
                </dd>
                
                <dt>Added</dt>
                <dd>{{ equipment.created_at[:10] if equipment.created_at else '-' }}</dd>
            </dl>
        </div>
    </div>
    
    <!-- Child Instruments Section -->
    <div class="detail-section full-width">
        <div class="section-header">
            <h2>Instruments</h2>
            <a href="{{ url_for('main.instrument_new', equipment_id=equipment.id) }}" class="btn btn-link btn-sm">Create New â†’</a>
        </div>
        <p class="section-description">PyBirch-compatible instruments that are part of this equipment.</p>
        {% if child_instruments %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>PyBirch Class</th>
                    <th>Status</th>
                    <th style="width: 80px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for inst in child_instruments %}
                <tr>
                    <td><a href="{{ url_for('main.instrument_detail', instrument_id=inst.id) }}">{{ inst.name }}</a></td>
                    <td>{{ inst.instrument_type or '-' }}</td>
                    <td><code>{{ inst.pybirch_class or '-' }}</code></td>
                    <td><span class="status-badge status-{{ inst.status }}">{{ inst.status }}</span></td>
                    <td class="actions-cell">
                        <form id="unlink-form-{{ inst.id }}" action="{{ url_for('main.equipment_unlink_instrument', equipment_id=equipment.id, instrument_id=inst.id) }}" method="POST" style="display: inline;">
                            <button type="button" class="btn-icon btn-icon-unlink" title="Unlink instrument" onclick="confirmUnlinkInstrument({{ inst.id }}, '{{ inst.name | e }}')">{{ icon_unlink() }}</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-text">No instruments linked to this equipment.</p>
        {% endif %}
        
        <!-- Link Existing Instrument Form -->
        <div class="link-instrument-form" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
            {% if available_instruments %}
            <form action="{{ url_for('main.equipment_link_instrument', equipment_id=equipment.id) }}" method="POST" class="inline-form">
                <div class="form-group" style="margin-bottom: 0;">
                    <label for="instrument_id" style="margin-bottom: 0.5rem;">Link Existing Instrument</label>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                        <select id="instrument_id" name="instrument_id" class="searchable-select" data-entity-type="instrument" style="flex: 1;">
                            <option value="">Select an instrument...</option>
                            {% for inst in available_instruments %}
                            <option value="{{ inst.id }}">{{ inst.name }}{% if inst.instrument_type %} ({{ inst.instrument_type }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn-icon btn-icon-add" title="Link instrument">{{ icon_plus() }}</button>
                    </div>
                </div>
            </form>
            {% else %}
            <p class="empty-text" style="margin: 0;">All instruments are already linked to equipment. <a href="{{ url_for('main.instrument_new', equipment_id=equipment.id) }}">Create a new instrument</a> to add more.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Maintenance Tasks Section -->
    <div class="detail-section full-width">
        <div class="section-header">
            <h2>Scheduled Maintenance</h2>
            <a href="{{ url_for('main.equipment_maintenance_tasks', equipment_id=equipment.id) }}" class="btn btn-link btn-sm">Manage Tasks â†’</a>
        </div>
        {% if maintenance_tasks %}
        <div class="maintenance-tasks-preview">
            {% for task in maintenance_tasks[:3] %}
            <div class="task-preview-item task-status-{{ task.status }}">
                <div class="task-preview-info">
                    <span class="task-preview-name">{{ task.name }}</span>
                    <span class="task-preview-interval">Every {{ task.interval_days }} days</span>
                </div>
                <div class="task-preview-status">
                    {% if not task.is_active %}
                    <span class="status-badge status-inactive">Paused</span>
                    {% elif task.status == 'overdue' %}
                    <span class="status-badge status-overdue">Overdue</span>
                    {% elif task.status == 'issue_open' %}
                    <a href="{{ url_for('main.equipment_issue_detail', equipment_id=equipment.id, issue_id=task.current_issue_id) }}" class="status-badge status-in_progress">Issue #{{ task.current_issue_id }}</a>
                    {% else %}
                    <span class="status-badge status-scheduled">Due {{ task.next_due_date }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% if maintenance_tasks|length > 3 %}
            <p class="more-tasks">+ {{ maintenance_tasks|length - 3 }} more tasks</p>
            {% endif %}
        </div>
        {% else %}
        <p class="empty-text">No scheduled maintenance tasks. <a href="{{ url_for('main.equipment_maintenance_task_new', equipment_id=equipment.id) }}">Create one</a></p>
        {% endif %}
    </div>
    
    <!-- Recent Issues Section -->
    {% if recent_issues %}
    <div class="detail-section full-width">
        <h2>Recent Issues</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Created</th>
                </tr>
            </thead>
            <tbody>
                {% for issue in recent_issues %}
                <tr>
                    <td><a href="{{ url_for('main.equipment_issue_detail', equipment_id=equipment.id, issue_id=issue.id) }}">{{ issue.title }}</a></td>
                    <td>{{ issue.category }}</td>
                    <td><span class="priority-badge priority-{{ issue.priority }}">{{ issue.priority }}</span></td>
                    <td><span class="status-badge status-{{ issue.status }}">{{ issue.status }}</span></td>
                    <td>{{ issue.created_at[:10] if issue.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <a href="{{ url_for('main.equipment_issues', equipment_id=equipment.id) }}" class="btn btn-link">View All Issues â†’</a>
    </div>
    {% endif %}
    
<!-- Location Section -->
{% include 'partials/location_section.html' %}

<!-- Images Section -->
{% include 'partials/image_gallery.html' %}

<!-- Files Section -->
{% include 'partials/file_gallery.html' %}
</div>

<style>
.section-description {
    margin-top: -0.5rem;
    margin-bottom: 1rem;
    color: var(--color-text-secondary);
    font-size: 0.9rem;
}
.detail-section.full-width {
    grid-column: 1 / -1;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
}
.priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}
.priority-low { background: #e3f2fd; color: #1565c0; }
.priority-medium { background: #fff3e0; color: #e65100; }
.priority-high { background: #ffebee; color: #c62828; }
.priority-critical { background: #c62828; color: white; }

.image-upload-section {
    margin-bottom: 1rem;
}
.image-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}
.gallery-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: var(--card-bg);
}
.gallery-item.primary {
    border: 2px solid #4caf50;
}
.gallery-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}
.image-caption {
    padding: 0.5rem;
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}
.image-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.25rem;
}
.empty-text {
    color: var(--text-secondary);
    font-style: italic;
}

/* Maintenance Tasks Preview */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}
.section-header h2 {
    margin: 0;
}
.maintenance-tasks-preview {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
.task-preview-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--bg-light, #f8f9fa);
    border-radius: 6px;
    border-left: 3px solid var(--border-color, #e0e0e0);
}
.task-preview-item.task-status-overdue {
    border-left-color: var(--danger-color, #dc3545);
    background: #fef2f2;
}
.task-preview-item.task-status-issue_open {
    border-left-color: var(--warning-color, #f59e0b);
    background: #fffbeb;
}
.task-preview-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.task-preview-name {
    font-weight: 500;
}
.task-preview-interval {
    font-size: 0.85rem;
    color: var(--text-secondary);
}
.status-badge.status-overdue {
    background: #fee2e2;
    color: #991b1b;
}
.status-badge.status-scheduled {
    background: #dcfce7;
    color: #166534;
}
.status-badge.status-inactive {
    background: #f3f4f6;
    color: #6b7280;
}
.more-tasks {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin: 0.5rem 0 0 0;
}
</style>

<script>
document.getElementById('image-file')?.addEventListener('change', function(e) {
    if (this.files.length > 0) {
        const formData = new FormData();
        formData.append('image', this.files[0]);
        
        fetch('{{ url_for("main.equipment_image_upload", equipment_id=equipment.id) }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error uploading image: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            alert('Error uploading image');
            console.error(err);
        });
    }
});

async function confirmUnlinkInstrument(instrumentId, instrumentName) {
    const confirmed = await PyBirchModal.confirm({
        type: 'warning',
        title: 'Unlink Instrument',
        body: `
            <p>Are you sure you want to unlink <strong>"${instrumentName}"</strong> from this equipment?</p>
            <div class="info-text">
                The instrument will not be deleted, only disconnected from this equipment.
            </div>
        `,
        cancelText: 'Cancel',
        confirmText: 'Unlink',
        confirmType: 'primary'
    });
    
    if (confirmed) {
        document.getElementById('unlink-form-' + instrumentId).submit();
    }
}
</script>
{% endblock %}
