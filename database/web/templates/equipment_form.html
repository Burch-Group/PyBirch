{% extends "base.html" %}

{% block title %}{{ action }} Equipment - PyBirch Database{% endblock %}

{% block content %}
<div class="form-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.equipment') }}">Equipment</a> / {{ action }}
        </div>
    </div>
    
    <h1>{{ action }} Equipment</h1>
    
    <form method="POST" class="entity-form">
        <div class="form-section">
            <h2>Basic Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" id="name" name="name" required
                           value="{{ equipment.name if equipment else '' }}"
                           placeholder="e.g., Main Glovebox">
                </div>
                
                <div class="form-group">
                    <label for="equipment_type">Type</label>
                    <select id="equipment_type" name="equipment_type" class="searchable-select" data-current-value="{{ equipment.equipment_type if equipment and equipment.equipment_type else '' }}">
                        <option value="">Select type...</option>
                        <!-- Options loaded dynamically based on selected lab -->
                    </select>
                    <small class="form-hint">Types are configured per lab</small>
                </div>
                
                <div class="form-group">
                    <label for="lab_id">Lab *</label>
                    <select id="lab_id" name="lab_id" class="searchable-select" data-entity-type="lab" required>
                        <option value="">-- Select Lab --</option>
                        {% for lab in labs %}
                        <option value="{{ lab.id }}" 
                                {% if (equipment and equipment.lab_id and equipment.lab_id == lab.id) or (default_lab_id == lab.id and (not equipment or not equipment.lab_id)) %}selected{% endif %}>
                            {{ lab.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small>Associate this equipment with a lab <a href="#" class="set-default-link" data-field="default_lab_id" data-source="lab_id">Set as default</a></small>
                </div>
                
                <div class="form-group full-width">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"
                              placeholder="Brief description of the equipment and its capabilities">{{ equipment.description if equipment else '' }}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="owner_id">Custodian</label>
                    <select id="owner_id" name="owner_id" class="searchable-select" data-entity-type="user">
                        <option value="">No custodian assigned</option>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if equipment and equipment.owner_id == user.id %}selected{% endif %}
                            data-name="{{ user.name or '' }}" data-username="{{ user.username }}" data-email="{{ user.email or '' }}">
                            {{ user.name or user.username }}{% if user.email %} ({{ user.email }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-hint">The person responsible for the care and maintenance of this equipment</small>
                </div>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status" class="searchable-select" data-current-value="{{ equipment.status if equipment and equipment.status else 'operational' }}">
                        <option value="operational" {% if equipment and equipment.status == 'operational' %}selected{% endif %}>Operational</option>
                        <option value="maintenance" {% if equipment and equipment.status == 'maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="offline" {% if equipment and equipment.status == 'offline' %}selected{% endif %}>Offline</option>
                        <option value="retired" {% if equipment and equipment.status == 'retired' %}selected{% endif %}>Retired</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Manufacturer Details</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="manufacturer">Manufacturer</label>
                    <input type="text" id="manufacturer" name="manufacturer"
                           value="{{ equipment.manufacturer if equipment else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="model">Model</label>
                    <input type="text" id="model" name="model"
                           value="{{ equipment.model if equipment else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="serial_number">Serial Number</label>
                    <input type="text" id="serial_number" name="serial_number"
                           value="{{ equipment.serial_number if equipment else '' }}">
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Location</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="db_location_id">Database Location</label>
                    <select id="db_location_id" name="db_location_id" class="searchable-select">
                        <option value="">(No tracked location)</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}" {% if equipment and equipment.current_location_id == loc.id %}selected{% endif %}>
                            {{ loc.name }} ({{ loc.location_type }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-hint">Track this equipment in a database location</small>
                </div>
                
                <div class="form-group">
                    <label for="location_notes">Location Notes</label>
                    <input type="text" id="location_notes" name="location_notes"
                           value="{{ equipment.current_location_notes if equipment else '' }}"
                           placeholder="e.g., 'on the top shelf'">
                    <small class="form-hint">Optional directions within the location</small>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2>Purchase & Warranty</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="purchase_date">Purchase Date</label>
                    <input type="date" id="purchase_date" name="purchase_date"
                           value="{{ equipment.purchase_date if equipment else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="warranty_expiration">Warranty Expiration</label>
                    <input type="date" id="warranty_expiration" name="warranty_expiration"
                           value="{{ equipment.warranty_expiration if equipment else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="documentation_url">Documentation URL</label>
                    <input type="url" id="documentation_url" name="documentation_url"
                           value="{{ equipment.documentation_url if equipment and equipment.documentation_url else '' }}"
                           placeholder="https://...">
                    <small class="form-hint">Link to manual or documentation</small>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <a href="{{ return_url or url_for('main.equipment') }}" class="btn btn-link">Cancel</a>
            <button type="submit" class="btn btn-primary">{{ action }} Equipment</button>
        </div>
    </form>
</div>

<style>
.form-section {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}
.form-section h2 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-size: 1.1rem;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 0.5rem;
}
.form-hint {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: #666;
}
.full-width {
    grid-column: 1 / -1;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const labSelect = document.getElementById('lab_id');
    const typeSelect = document.getElementById('equipment_type');
    const currentValue = typeSelect.dataset.currentValue || '';
    
    // Default types (fallback if no lab selected or API fails)
    const defaultTypes = ['glovebox', 'chamber', 'lithography', 'furnace', 'other'];
    
    function updateTypeOptions(types, selectedValue) {
        // Clear existing options except the first placeholder
        typeSelect.innerHTML = '<option value="">Select type...</option>';
        
        // Add new options
        types.forEach(function(type) {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            if (type === selectedValue) {
                option.selected = true;
            }
            typeSelect.appendChild(option);
        });
        
        // Re-render the searchable-select wrapper if initialized
        const wrapper = typeSelect.closest('.searchable-select-wrapper');
        if (wrapper) {
            const selectedText = wrapper.querySelector('.selected-text');
            const optionsList = wrapper.querySelector('.searchable-select-options');
            const selectedOption = typeSelect.options[typeSelect.selectedIndex];
            
            if (selectedText) {
                selectedText.textContent = selectedOption ? selectedOption.text : 'Select type...';
            }
            
            if (optionsList) {
                optionsList.innerHTML = '';
                Array.from(typeSelect.options).forEach(function(opt) {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'searchable-option';
                    optionDiv.dataset.value = opt.value;
                    optionDiv.textContent = opt.text;
                    
                    if (opt.value === typeSelect.value) {
                        optionDiv.classList.add('selected');
                    }
                    
                    optionDiv.addEventListener('click', function() {
                        typeSelect.value = opt.value;
                        typeSelect.dispatchEvent(new Event('change'));
                        selectedText.textContent = opt.text;
                        wrapper.classList.remove('open');
                        // Update selected state
                        optionsList.querySelectorAll('.searchable-option').forEach(function(o) {
                            o.classList.toggle('selected', o.dataset.value === opt.value);
                        });
                    });
                    
                    optionsList.appendChild(optionDiv);
                });
            }
        }
    }
    
    function loadLabTypes(labId) {
        if (!labId) {
            updateTypeOptions(defaultTypes, currentValue);
            return;
        }
        
        fetch('/labs/' + labId + '/types')
            .then(function(response) {
                if (!response.ok) throw new Error('Failed to load types');
                return response.json();
            })
            .then(function(data) {
                const types = data.equipment_types || defaultTypes;
                updateTypeOptions(types, currentValue);
            })
            .catch(function(error) {
                console.error('Error loading lab types:', error);
                updateTypeOptions(defaultTypes, currentValue);
            });
    }
    
    // Load types when lab changes
    labSelect.addEventListener('change', function() {
        loadLabTypes(this.value);
    });
    
    // Load initial types if lab is already selected
    if (labSelect.value) {
        loadLabTypes(labSelect.value);
    } else {
        updateTypeOptions(defaultTypes, currentValue);
    }
});
</script>
{% endblock %}
