{% extends "base.html" %}

{% block title %}Shared Calendar - {{ equipment.name }} - PyBirch Database{% endblock %}

{% block content %}
<div class="list-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.equipment_list') }}">Equipment</a> /
            <a href="{{ url_for('main.equipment_detail', equipment_id=equipment.id) }}">{{ equipment.name }}</a> /
            <a href="{{ url_for('main.equipment_schedule_settings', equipment_id=equipment.id) }}">Schedule Settings</a> /
            Shared Calendar
        </div>
    </div>
    
    <div class="detail-header">
        <h1>Shared Calendar for {{ equipment.name }}</h1>
    </div>
    <p class="section-description">
        Create and manage a shared Google Calendar so all lab members can see this equipment's schedule.
    </p>
    
    {% if not google_available %}
    <div class="flash flash-warning">
        <strong>Google Calendar not configured.</strong>
        To enable shared calendars, set the <code>GOOGLE_CALENDAR_CLIENT_ID</code> and 
        <code>GOOGLE_CALENDAR_CLIENT_SECRET</code> environment variables.
        <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Get credentials from Google Cloud Console</a>
    </div>
    {% else %}
    
    {% if not config or not config.google_calendar_id %}
    <!-- No shared calendar yet - show creation form -->
    <div class="card">
        <h2>Create Shared Calendar</h2>
        <p>Create a new Google Calendar that will be automatically populated with this equipment's bookings.</p>
        
        <form method="POST" action="{{ url_for('main.equipment_shared_calendar', equipment_id=equipment.id) }}">
            <input type="hidden" name="action" value="create_calendar">
            
            <div class="form-group">
                <label for="calendar_name">Calendar Name</label>
                <input type="text" id="calendar_name" name="calendar_name" 
                       value="{{ equipment.name }} Schedule" class="form-control"
                       placeholder="e.g., NMR Spectrometer Schedule">
            </div>
            
            <button type="submit" class="btn btn-primary">
                üìÖ Create Shared Calendar
            </button>
        </form>
        
        <div class="info-box" style="margin-top: 1rem;">
            <strong>Note:</strong> The calendar will be created in your Google account. 
            You can then share it with lab members, your domain, or make it public.
        </div>
    </div>
    
    {% else %}
    <!-- Shared calendar exists - show management options -->
    
    <div class="settings-grid" style="display: grid; gap: 1.5rem;">
        
        <!-- Calendar Info -->
        <div class="card">
            <h2>‚úÖ Shared Calendar Active</h2>
            <table class="info-table">
                <tr>
                    <th>Calendar Name:</th>
                    <td>{{ config.shared_calendar_name or 'Equipment Schedule' }}</td>
                </tr>
                <tr>
                    <th>Calendar ID:</th>
                    <td><code style="font-size: 0.75rem; word-break: break-all;">{{ config.google_calendar_id }}</code></td>
                </tr>
                <tr>
                    <th>Last Synced:</th>
                    <td>{{ config.last_calendar_sync | replace('T', ' ') if config.last_calendar_sync else 'Never' }}</td>
                </tr>
                <tr>
                    <th>Public:</th>
                    <td>{{ '‚úÖ Yes' if config.shared_calendar_public else '‚ùå No' }}</td>
                </tr>
            </table>
            
            {% if share_link %}
            <div class="share-links" style="margin-top: 1rem; padding: 1rem; background: var(--color-bg-secondary); border-radius: var(--border-radius);">
                <p><strong>üì§ Share this calendar:</strong></p>
                <div style="margin-bottom: 0.5rem;">
                    <label>View Link:</label>
                    <input type="text" value="{{ share_link }}" readonly class="form-control" style="font-size: 0.75rem;"
                           onclick="this.select(); document.execCommand('copy');">
                </div>
                <div>
                    <label>Embed Code:</label>
                    <textarea readonly class="form-control" rows="2" style="font-size: 0.75rem;"
                              onclick="this.select(); document.execCommand('copy');">&lt;iframe src="{{ embed_link }}" style="border: 0" width="800" height="600"&gt;&lt;/iframe&gt;</textarea>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Sync Bookings -->
        <div class="card">
            <h2>üîÑ Sync Bookings</h2>
            <p>Populate the shared calendar with current and upcoming equipment bookings.</p>
            
            <form method="POST" action="{{ url_for('main.equipment_shared_calendar', equipment_id=equipment.id) }}">
                <input type="hidden" name="action" value="populate">
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="clear_existing" value="1">
                        Clear existing events first (removes all PyBirch events, then re-adds current bookings)
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    üîÑ Sync Now
                </button>
            </form>
            
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--color-text-secondary);">
                Tip: New bookings are automatically synced when created. Use this to manually sync 
                existing bookings or fix any discrepancies.
            </p>
        </div>
        
        <!-- Share with Domain -->
        <div class="card">
            <h2>üè¢ Share with Organization</h2>
            <p>Share the calendar with everyone in your organization's domain.</p>
            
            <form method="POST" action="{{ url_for('main.equipment_shared_calendar', equipment_id=equipment.id) }}">
                <input type="hidden" name="action" value="share_domain">
                
                <div class="form-group">
                    <label for="domain">Domain</label>
                    <input type="text" id="domain" name="domain" class="form-control"
                           placeholder="e.g., university.edu"
                           value="{{ config.shared_calendar_domain or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="domain_role">Access Level</label>
                    <select id="domain_role" name="role" class="form-control">
                        <option value="reader">View only (reader)</option>
                        <option value="writer">Can edit (writer)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-secondary">
                    üè¢ Share with Domain
                </button>
            </form>
        </div>
        
        <!-- Share with Individual -->
        <div class="card">
            <h2>üë§ Share with User</h2>
            <p>Share the calendar with a specific user by email.</p>
            
            <form method="POST" action="{{ url_for('main.equipment_shared_calendar', equipment_id=equipment.id) }}">
                <input type="hidden" name="action" value="share_user">
                
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" class="form-control"
                           placeholder="user@example.com">
                </div>
                
                <div class="form-group">
                    <label for="user_role">Access Level</label>
                    <select id="user_role" name="role" class="form-control">
                        <option value="reader">View only (reader)</option>
                        <option value="writer">Can edit (writer)</option>
                        <option value="owner">Owner (full control)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-secondary">
                    üë§ Share with User
                </button>
            </form>
        </div>
        
        <!-- Make Public -->
        {% if not config.shared_calendar_public %}
        <div class="card">
            <h2>üåê Make Calendar Public</h2>
            <p>Make the calendar viewable by anyone with the link (no Google account required).</p>
            
            <form method="POST" action="{{ url_for('main.equipment_shared_calendar', equipment_id=equipment.id) }}">
                <input type="hidden" name="action" value="make_public">
                <button type="submit" class="btn btn-warning"
                        onclick="return confirm('Make this calendar publicly viewable?')">
                    üåê Make Public
                </button>
            </form>
        </div>
        {% endif %}
        
        <!-- Current Subscribers -->
        {% if subscribers %}
        <div class="card">
            <h2>üìã Current Access</h2>
            <p>Users and domains with access to this calendar:</p>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Email/Domain</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in subscribers %}
                    <tr>
                        <td>
                            {% if sub.type == 'user' %}üë§ User
                            {% elif sub.type == 'domain' %}üè¢ Domain
                            {% elif sub.type == 'default' %}üåê Public
                            {% else %}{{ sub.type }}
                            {% endif %}
                        </td>
                        <td>{{ sub.email or '(everyone)' }}</td>
                        <td>{{ sub.role }}</td>
                        <td>
                            {% if sub.role != 'owner' %}
                            <form method="POST" style="display: inline;">
                                <input type="hidden" name="action" value="remove_access">
                                <input type="hidden" name="rule_id" value="{{ sub.id }}">
                                <button type="submit" class="btn btn-danger btn-sm"
                                        onclick="return confirm('Remove this access?')">
                                    Remove
                                </button>
                            </form>
                            {% else %}
                            <span style="color: var(--color-text-secondary);">Owner</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
        
    </div>
    {% endif %}
    {% endif %}
    
    <div class="header-actions" style="margin-top: 2rem;">
        <a href="{{ url_for('main.equipment_schedule_settings', equipment_id=equipment.id) }}" class="btn btn-secondary">
            ‚Üê Back to Schedule Settings
        </a>
    </div>
</div>

<style>
.card {
    background: var(--color-bg-primary);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    border: 1px solid var(--color-border);
    box-shadow: var(--shadow);
}

.card h2 {
    margin-top: 0;
    font-size: 1.25rem;
}

.info-table {
    width: 100%;
}

.info-table th {
    text-align: left;
    padding: 0.5rem 1rem 0.5rem 0;
    width: 150px;
    vertical-align: top;
}

.info-table td {
    padding: 0.5rem 0;
}

.info-box {
    background: var(--color-bg-secondary);
    border-left: 4px solid var(--color-primary);
    padding: 1rem;
    border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
}

.data-table th {
    font-weight: 600;
    background: var(--color-bg-secondary);
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}
</style>
{% endblock %}
