{% extends "base.html" %}
{% from "macros.html" import action_buttons %}

{% block title %}Procedures - PyBirch Database{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-title-row">
        <div>
            <h1>Procedures</h1>
            <p class="subtitle">Fabrication procedures and workflows</p>
        </div>
        <a href="{{ url_for('main.procedure_new') }}" class="btn btn-primary">+ New Procedure</a>
    </div>
</div>

<div class="filters">
    <form method="get" action="{{ url_for('main.procedures') }}">
        <div class="filter-group">
            <input type="text" name="search" placeholder="Search procedures..." 
                   value="{{ search }}" class="search-input">
            <select name="type" class="filter-select">
                <option value="">All Types</option>
                <option value="deposition" {% if procedure_type == 'deposition' %}selected{% endif %}>Deposition</option>
                <option value="annealing" {% if procedure_type == 'annealing' %}selected{% endif %}>Annealing</option>
                <option value="etching" {% if procedure_type == 'etching' %}selected{% endif %}>Etching</option>
                <option value="cleaning" {% if procedure_type == 'cleaning' %}selected{% endif %}>Cleaning</option>
                <option value="characterization" {% if procedure_type == 'characterization' %}selected{% endif %}>Characterization</option>
            </select>
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </form>
</div>

<div class="results-summary">
    Showing {{ procedures|length }} of {{ total }} procedures
</div>

{% if procedures %}
{# Separate pinned and unpinned items #}
{% set pinned_items = procedures | selectattr('id', 'in', pinned_ids) | list %}
{% set unpinned_items = procedures | rejectattr('id', 'in', pinned_ids) | list %}

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th style="width: 30px;"></th>
                <th>Name</th>
                <th>Type</th>
                <th>Version</th>
                <th>Duration</th>
                <th>Created By</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {# Pinned items first #}
            {% for procedure in pinned_items %}
            <tr class="pinned-row">
                <td>
                    {% if current_user %}
                    <button class="pin-btn pinned" data-entity-type="procedure" data-entity-id="{{ procedure.id }}" title="Unpin">üìå</button>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('main.procedure_detail', procedure_id=procedure.id) }}">
                        {{ procedure.name }}
                    </a>
                </td>
                <td>
                    {% if procedure.procedure_type %}
                    <span class="badge badge-{{ procedure.procedure_type }}">{{ procedure.procedure_type }}</span>
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>v{{ procedure.version }}</td>
                <td>
                    {% if procedure.estimated_duration_minutes %}
                    {{ procedure.estimated_duration_minutes }} min
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ procedure.created_by or '‚Äî' }}</td>
                <td>
                    {{ action_buttons(
                        view_url=url_for('main.procedure_detail', procedure_id=procedure.id),
                        edit_url=url_for('main.procedure_edit', procedure_id=procedure.id),
                        entity_type='procedure',
                        entity_id=procedure.id
                    ) }}
                </td>
            </tr>
            {% endfor %}
            {# Unpinned items #}
            {% for procedure in unpinned_items %}
            <tr>
                <td>
                    {% if current_user %}
                    <button class="pin-btn" data-entity-type="procedure" data-entity-id="{{ procedure.id }}" title="Pin">üìç</button>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('main.procedure_detail', procedure_id=procedure.id) }}">
                        {{ procedure.name }}
                    </a>
                </td>
                <td>
                    {% if procedure.procedure_type %}
                    <span class="badge badge-{{ procedure.procedure_type }}">{{ procedure.procedure_type }}</span>
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>v{{ procedure.version }}</td>
                <td>
                    {% if procedure.estimated_duration_minutes %}
                    {{ procedure.estimated_duration_minutes }} min
                    {% else %}
                    <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>{{ procedure.created_by or '‚Äî' }}</td>
                <td>
                    {{ action_buttons(
                        view_url=url_for('main.procedure_detail', procedure_id=procedure.id),
                        edit_url=url_for('main.procedure_edit', procedure_id=procedure.id),
                        entity_type='procedure',
                        entity_id=procedure.id
                    ) }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="{{ url_for('main.procedures', page=page-1, search=search, type=procedure_type) }}" class="btn btn-small">‚Üê Previous</a>
    {% endif %}
    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
    {% if page < total_pages %}
    <a href="{{ url_for('main.procedures', page=page+1, search=search, type=procedure_type) }}" class="btn btn-small">Next ‚Üí</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="empty-state">
    <p>No procedures found.</p>
    <p class="text-muted">Procedures define fabrication workflows with steps, equipment, and precursors.</p>
</div>
{% endif %}
{% endblock %}
