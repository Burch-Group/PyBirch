{% extends "base.html" %}

{% block title %}{{ action }} Precursor - PyBirch Database{% endblock %}

{% block content %}
<div class="form-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.precursors') }}">Precursors</a> / {{ action }}
        </div>
    </div>
    
    <h1>{{ action }} Precursor</h1>
    
    {% if template %}
    <div class="template-notice">
        <span class="template-badge">Using Template</span>
        <strong>{{ template.name }}</strong>
        {% if template.lab_name or (template.template_data and template.template_data.lab_name) %}
         - {{ template.lab_name or template.template_data.lab_name }}
        {% endif %}
        <p class="template-hint">Fields have been pre-filled from the template. You can modify them as needed.</p>
    </div>
    {% endif %}
    
    {% if original_precursor %}
    <div class="replace-notice">
        <span class="replace-badge">ðŸ”„ Replacing</span>
        <strong>{{ original_precursor.name }}</strong>
        {% if original_precursor.chemical_formula %}<code>{{ original_precursor.chemical_formula }}</code>{% endif %}
        <p class="replace-hint">Creating a new precursor that will replace the original in all templates that reference it.</p>
    </div>
    {% endif %}
    
    <form method="POST" class="entity-form">
        <!-- Lab & Project Assignment Section -->
        <div class="form-section">
            <h2>Assignment</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="lab_id">Lab *</label>
                    <select id="lab_id" name="lab_id" class="searchable-select" data-entity-type="lab" required>
                        <option value="">-- Select Lab --</option>
                        {% for lab in labs %}
                        <option value="{{ lab.id }}" 
                                {% if (precursor and precursor.lab_id and precursor.lab_id == lab.id) or (default_lab_id == lab.id and (not precursor or not precursor.lab_id)) %}selected{% endif %}>
                            {{ lab.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <small>Associate this precursor with a lab 
                        {% if current_user %}<a href="#" class="set-default-link" data-field="lab_id">Set as default</a>{% endif %}
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="project_id">Project</label>
                    <select id="project_id" name="project_id" class="searchable-select" data-entity-type="project">
                        <option value="">-- No Project --</option>
                        {% for project in projects %}
                        <option value="{{ project.id }}" 
                                {% if (precursor and precursor.project_id and precursor.project_id == project.id) or (default_project_id == project.id and (not precursor or not precursor.project_id)) %}selected{% endif %}>
                            {{ project.display }}
                        </option>
                        {% endfor %}
                    </select>
                    <small>Associate this precursor with a project 
                        {% if current_user %}<a href="#" class="set-default-link" data-field="project_id">Set as default</a>{% endif %}
                    </small>
                </div>
            </div>
        </div>

        <!-- Basic Information -->
        <div class="form-section">
            <h2>Basic Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="name">Name *</label>
                    <input type="text" id="name" name="name" required
                           value="{{ precursor.name if precursor else '' }}"
                           placeholder="e.g., Gold(III) chloride">
                </div>
                
                <div class="form-group">
                    <label for="chemical_formula">Chemical Formula</label>
                    <input type="text" id="chemical_formula" name="chemical_formula"
                           value="{{ precursor.chemical_formula if precursor else '' }}"
                           placeholder="e.g., AuCl3">
                </div>
                
                <div class="form-group">
                    <label for="cas_number">CAS Number</label>
                    <input type="text" id="cas_number" name="cas_number"
                           value="{{ precursor.cas_number if precursor else '' }}"
                           placeholder="e.g., 13453-07-1">
                </div>
                
                <div class="form-group">
                    <label for="supplier">Supplier</label>
                    <input type="text" id="supplier" name="supplier"
                           value="{{ precursor.supplier if precursor else '' }}"
                           placeholder="e.g., Sigma-Aldrich">
                </div>
                
                <div class="form-group">
                    <label for="lot_number">Lot Number</label>
                    <input type="text" id="lot_number" name="lot_number"
                           value="{{ precursor.lot_number if precursor else '' }}">
                </div>
                
                <div class="form-group">
                    <label for="purity">Purity (%)</label>
                    <input type="number" id="purity" name="purity" step="0.01" min="0" max="100"
                           value="{{ precursor.purity if precursor else '' }}"
                           placeholder="e.g., 99.9">
                </div>
                
                <div class="form-group">
                    <label for="state">State</label>
                    <select id="state" name="state">
                        <option value="">Select state...</option>
                        <option value="solid" {% if precursor and precursor.state == 'solid' %}selected{% endif %}>Solid</option>
                        <option value="liquid" {% if precursor and precursor.state == 'liquid' %}selected{% endif %}>Liquid</option>
                        <option value="gas" {% if precursor and precursor.state == 'gas' %}selected{% endif %}>Gas</option>
                        <option value="solution" {% if precursor and precursor.state == 'solution' %}selected{% endif %}>Solution</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status" class="searchable-select" data-current-value="{{ precursor.status if precursor and precursor.status else 'new' }}">
                        <option value="new" {% if precursor and precursor.status == 'new' %}selected{% endif %}>New</option>
                        <option value="in_use" {% if precursor and precursor.status == 'in_use' %}selected{% endif %}>In Use</option>
                        <option value="low" {% if precursor and precursor.status == 'low' %}selected{% endif %}>Low</option>
                        <option value="empty" {% if precursor and precursor.status == 'empty' %}selected{% endif %}>Empty</option>
                        <option value="expired" {% if precursor and precursor.status == 'expired' %}selected{% endif %}>Expired</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Location</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="db_location_id">Database Location</label>
                    <select id="db_location_id" name="db_location_id" class="searchable-select">
                        <option value="">(No tracked location)</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}" {% if precursor and precursor.current_location_id == loc.id %}selected{% endif %}>
                            {{ loc.name }} ({{ loc.location_type }})
                        </option>
                        {% endfor %}
                    </select>
                    <small class="form-hint">Track this precursor in a database location</small>
                </div>
                
                <div class="form-group">
                    <label for="location_notes">Location Notes</label>
                    <input type="text" id="location_notes" name="location_notes"
                           value="{{ precursor.current_location_notes if precursor else '' }}"
                           placeholder="e.g., 'in the blue bottle', 'second shelf'">
                    <small class="form-hint">Optional directions within the location</small>
                </div>
            </div>
        </div>
        
        <div class="form-group form-group-full">
            <label for="storage_conditions">Storage Conditions</label>
            <textarea id="storage_conditions" name="storage_conditions" rows="3"
                      placeholder="e.g., Store in a cool, dry place. Keep away from light.">{{ precursor.storage_conditions if precursor else '' }}</textarea>
        </div>
        
        <div class="form-actions">
            <a href="{{ url_for('main.precursors') }}" class="btn btn-link">Cancel</a>
            <button type="submit" class="btn btn-primary">{{ action }} Precursor</button>
        </div>
    </form>
</div>

<style>
.template-notice {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 1px solid #81c784;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
}
.template-badge {
    background: #4caf50;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
}
.template-notice strong { color: #2e7d32; }
.template-hint {
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    color: #558b2f;
}

.replace-notice {
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
    border: 1px solid #ffb74d;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
}
.replace-badge {
    background: #ff9800;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
}
.replace-notice strong { color: #e65100; margin-right: 0.5rem; }
.replace-notice code { 
    background: rgba(0,0,0,0.1); 
    padding: 0.1rem 0.3rem; 
    border-radius: 3px;
    font-size: 0.9rem;
}
.replace-hint {
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    color: #f57c00;
}
</style>
{% endblock %}
