<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PyBirch Database{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/precursors.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <!-- Theme initialization (runs before page render to prevent flash) -->
    <script>
        (function() {
            // Get stored theme preference
            const stored = localStorage.getItem('pybirch-theme-mode');
            const theme = stored || 'system';
            
            // Apply theme immediately to prevent flash
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            }
            // 'system' will use CSS media query
        })();
    </script>
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        /* Real-time connection indicator */
        .connection-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .connection-status.connected { background: #22c55e; }
        .connection-status.disconnected { background: #ef4444; }
        .connection-status.connecting { background: #f59e0b; animation: pulse 1s infinite; }
        
        /* Status change highlight animation */
        .status-updated {
            animation: highlight 2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
        
        /* Live badge pulse for running status */
        .status-badge.status-running {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Connection status text */
        .connection-status-text {
            font-size: 0.75rem;
            margin-left: 4px;
        }
        .connection-status-text.connected { color: #22c55e; }
        .connection-status-text.disconnected { color: #ef4444; }
        .connection-status-text.connecting { color: #f59e0b; }
        
        /* Live indicator */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
            color: #ef4444;
        }
        .live-indicator::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 1s infinite;
        }
        
        /* Position panel for instruments */
        .position-panel {
            font-family: 'Courier New', monospace;
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .position-axis {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        .position-label {
            font-weight: bold;
            color: #94a3b8;
        }
        .position-value {
            color: #22d3ee;
            font-weight: bold;
            font-size: 1.1em;
        }
        .position-value.moving {
            color: #fbbf24;
            animation: pulse 0.5s infinite;
        }
        .position-target {
            color: #64748b;
            font-size: 0.9em;
        }
        
        /* Log panel */
        .log-panel {
            max-height: 300px;
            overflow-y: auto;
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .log-entry {
            padding: 4px 8px;
            border-radius: 4px;
            margin: 2px 0;
        }
        .log-entry.DEBUG { color: #64748b; }
        .log-entry.INFO { color: #e2e8f0; }
        .log-entry.WARNING { color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .log-entry.ERROR { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .log-timestamp {
            color: #64748b;
            margin-right: 8px;
        }
        
        /* Live data chart container */
        .live-chart-container {
            position: relative;
            min-height: 300px;
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        
        /* Live activity panel */
        .live-activity-panel {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .live-activity-panel h3 {
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
        }
        .live-activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 8px 0;
            border: 1px solid #e2e8f0;
        }
        .live-activity-item:hover {
            background: #f1f5f9;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <button class="hamburger-btn" id="hamburger-btn" aria-label="Toggle menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <div class="nav-brand">
            <a href="{{ url_for('main.index') }}">üå≥<span class="brand-text"> PyBirch Database</span></a>
        </div>
        <div class="nav-search">
            <form action="{{ url_for('main.search') }}" method="GET">
                <input type="text" name="q" placeholder="Search everything..." 
                       value="{{ request.args.get('q', '') }}" class="search-input">
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </div>
        <div class="nav-user">
            <!-- Dark Mode Toggle -->
            <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark mode">
                <!-- Sun icon (shown when in dark mode, click to switch to light) -->
                <svg class="icon-sun" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"/>
                    <line x1="12" y1="1" x2="12" y2="3"/>
                    <line x1="12" y1="21" x2="12" y2="23"/>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line x1="1" y1="12" x2="3" y2="12"/>
                    <line x1="21" y1="12" x2="23" y2="12"/>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <!-- Moon icon (shown when in light mode, click to switch to dark) -->
                <svg class="icon-moon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                </svg>
            </button>
            
            {% if current_user %}
            <div class="user-dropdown">
                <button class="user-btn">üë§ {{ current_user.name or current_user.username }}</button>
                <div class="user-menu">
                    <a href="{{ url_for('main.profile') }}">Profile</a>
                    <a href="{{ url_for('main.settings') }}">Settings</a>
                    <a href="{{ url_for('main.user_statistics') }}">Statistics</a>
                    <a href="{{ url_for('main.logout') }}">Logout</a>
                </div>
            </div>
            {% else %}
            <a href="{{ url_for('main.login') }}" class="btn btn-secondary btn-sm">Login</a>
            {% endif %}
        </div>
    </nav>
    
    <!-- Slide-out Navigation Menu -->
    <div class="nav-overlay" id="nav-overlay"></div>
    <div class="nav-drawer" id="nav-drawer">
        <div class="nav-drawer-header">
            <span>Navigation</span>
            <button class="nav-drawer-close" id="nav-drawer-close">&times;</button>
        </div>
        <div class="nav-drawer-links">
            <a href="{{ url_for('main.labs') }}" class="nav-drawer-link {% if request.endpoint and 'lab' in request.endpoint and 'permission' not in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/labs.svg') }}" class="nav-icon" alt="">
                <span>Labs</span>
            </a>
            <a href="{{ url_for('main.projects') }}" class="nav-drawer-link {% if request.endpoint and 'project' in request.endpoint and 'permission' not in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/projects.svg') }}" class="nav-icon" alt="">
                <span>Projects</span>
            </a>
            <a href="{{ url_for('main.samples') }}" class="nav-drawer-link {% if request.endpoint and 'sample' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/samples.svg') }}" class="nav-icon" alt="">
                <span>Samples</span>
            </a>
            <a href="{{ url_for('main.templates') }}" class="nav-drawer-link {% if request.endpoint and 'template' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/templates.svg') }}" class="nav-icon" alt="">
                <span>Templates</span>
            </a>
            <a href="{{ url_for('main.scans') }}" class="nav-drawer-link {% if request.endpoint and 'scan' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/scans.svg') }}" class="nav-icon" alt="">
                <span>Scans</span>
            </a>
            <a href="{{ url_for('main.queues') }}" class="nav-drawer-link {% if request.endpoint and 'queue' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/queues.svg') }}" class="nav-icon" alt="">
                <span>Queues</span>
            </a>
            <a href="{{ url_for('main.instruments') }}" class="nav-drawer-link {% if request.endpoint and 'instrument' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/instruments.svg') }}" class="nav-icon" alt="">
                <span>Instruments</span>
            </a>
            <a href="{{ url_for('main.drivers') }}" class="nav-drawer-link {% if request.endpoint and 'driver' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/drivers.svg') }}" class="nav-icon" alt="">
                <span>Drivers</span>
            </a>
            <a href="{{ url_for('main.computers') }}" class="nav-drawer-link {% if request.endpoint and 'computer' in request.endpoint and 'binding' not in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/computers.svg') }}" class="nav-icon" alt="">
                <span>Computers</span>
            </a>
            <a href="{{ url_for('main.equipment') }}" class="nav-drawer-link {% if request.endpoint and 'equipment' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/equipment.svg') }}" class="nav-icon" alt="">
                <span>Equipment</span>
            </a>
            <a href="{{ url_for('main.locations') }}" class="nav-drawer-link {% if request.endpoint and 'location' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/locations.svg') }}" class="nav-icon" alt="">
                <span>Locations</span>
            </a>
            <a href="{{ url_for('main.precursors') }}" class="nav-drawer-link {% if request.endpoint and 'precursor' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/precursors.svg') }}" class="nav-icon" alt="">
                <span>Precursors</span>
            </a>
            <a href="{{ url_for('main.procedures') }}" class="nav-drawer-link {% if request.endpoint and 'procedure' in request.endpoint and 'fabrication_run' not in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/procedures.svg') }}" class="nav-icon" alt="">
                <span>Procedures</span>
            </a>
            <a href="{{ url_for('main.fabrication_runs') }}" class="nav-drawer-link {% if request.endpoint and 'fabrication_run' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/fabrication_runs.svg') }}" class="nav-icon" alt="">
                <span>Fabrication Runs</span>
            </a>
            <a href="{{ url_for('main.issues') }}" class="nav-drawer-link {% if request.endpoint and 'issue' in request.endpoint and 'equipment_issue' not in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/issues.svg') }}" class="nav-icon" alt="">
                <span>Issues</span>
            </a>
            {% if current_user %}
            <a href="{{ url_for('main.archive') }}" class="nav-drawer-link {% if request.endpoint == 'main.archive' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/archive.svg') }}" class="nav-icon" alt="">
                <span>Archive</span>
            </a>
            <a href="{{ url_for('main.trash') }}" class="nav-drawer-link {% if request.endpoint == 'main.trash' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/trash.svg') }}" class="nav-icon" alt="">
                <span>Trash</span>
            </a>
            {% endif %}
            {% if current_user and current_user.role == 'admin' %}
            <a href="{{ url_for('main.permissions') }}" class="nav-drawer-link nav-drawer-link-admin {% if request.endpoint and 'permission' in request.endpoint %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/permissions.svg') }}" class="nav-icon" alt="">
                <span>Permissions</span>
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- Filter Toggle Button (top right) -->
    <button class="filter-toggle-btn {% if has_active_filter %}has-filter{% endif %}" id="filter-toggle-btn" title="Toggle Filters">
        <span class="filter-icon-bars">
            <span></span>
            <span></span>
            <span></span>
        </span>
        {% if has_active_filter %}
        <span class="filter-indicator"></span>
        {% endif %}
    </button>
    
    <!-- Site-Wide Filter Row (Collapsible, beneath header) -->
    <div class="filter-row collapsed" id="filter-bar">
        <div class="filter-row-content">
            <form action="{{ url_for('main.set_site_filters') }}" method="POST" class="filter-row-form" id="site-filter-form">
                <div class="filter-row-group">
                    <label for="filter-lab-select">Lab:</label>
                    <select name="lab_id" id="filter-lab-select" class="filter-select" onchange="updateProjectOptions()">
                        <option value="">All Labs</option>
                        {% for lab in filter_labs %}
                        <option value="{{ lab.id }}" {% if filter_lab_id == lab.id %}selected{% endif %}>
                            {{ lab.display }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-row-group">
                    <label for="filter-project-select">Project:</label>
                    <select name="project_id" id="filter-project-select" class="filter-select">
                        <option value="">All Projects</option>
                        {% for project in filter_projects %}
                        <option value="{{ project.id }}" {% if filter_project_id == project.id %}selected{% endif %}
                                data-lab-id="{{ project.lab_id }}">
                            {{ project.display }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-row-group filter-row-checkboxes">
                    <label class="filter-checkbox-label">
                        <input type="checkbox" name="show_archived" value="1" {% if show_archived %}checked{% endif %}>
                        <span>üì¶ Show Archived</span>
                    </label>
                    <label class="filter-checkbox-label">
                        <input type="checkbox" name="show_trashed" value="1" {% if show_trashed %}checked{% endif %}>
                        <span>üóëÔ∏è Show Trashed</span>
                    </label>
                </div>
                <div class="filter-row-actions">
                    <button type="submit" class="btn btn-primary btn-sm">Apply</button>
                    {% if has_active_filter %}
                    <a href="{{ url_for('main.clear_site_filters') }}" class="btn btn-secondary btn-sm">Clear</a>
                    {% endif %}
                </div>
                {% if has_active_filter %}
                <div class="filter-row-active">
                    <span>Active:</span>
                    {% if filter_lab_name %}
                    <span class="filter-badge filter-badge-lab">{{ filter_lab_name }}</span>
                    {% endif %}
                    {% if filter_project_name %}
                    <span class="filter-badge filter-badge-project">{{ filter_project_name }}</span>
                    {% endif %}
                    {% if show_archived %}
                    <span class="filter-badge filter-badge-archived">üì¶ Archived</span>
                    {% endif %}
                    {% if show_trashed %}
                    <span class="filter-badge filter-badge-trashed">üóëÔ∏è Trashed</span>
                    {% endif %}
                </div>
                {% endif %}
            </form>
            <button class="filter-row-close" id="filter-row-close" title="Close filters">&times;</button>
        </div>
    </div>
    
    <main class="main-content">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        {% block content %}{% endblock %}
    </main>
    
    <footer class="footer">
        <p>PyBirch Database Browser &copy; 2025</p>
    </footer>
    
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
    // Site-wide filter functionality
    function updateProjectOptions() {
        const labSelect = document.getElementById('filter-lab-select');
        const projectSelect = document.getElementById('filter-project-select');
        const selectedLabId = labSelect.value;
        
        // Get all project options
        const projectOptions = projectSelect.querySelectorAll('option');
        
        projectOptions.forEach(option => {
            if (option.value === '') {
                // Always show "All Projects" option
                option.style.display = '';
                option.disabled = false;
            } else {
                const optionLabId = option.getAttribute('data-lab-id');
                if (!selectedLabId || optionLabId === selectedLabId) {
                    option.style.display = '';
                    option.disabled = false;
                } else {
                    option.style.display = 'none';
                    option.disabled = true;
                    // If this option was selected, reset to "All Projects"
                    if (option.selected) {
                        projectSelect.value = '';
                    }
                }
            }
        });
        
        // If searchable-select is initialized, re-render its options
        const projectWrapper = projectSelect.closest('.searchable-select-wrapper');
        if (projectWrapper) {
            const selectedText = projectWrapper.querySelector('.selected-text');
            if (selectedText) {
                const selectedOption = projectSelect.options[projectSelect.selectedIndex];
                selectedText.textContent = selectedOption ? selectedOption.text : 'All Projects';
            }
            // Re-render the dropdown options
            const optionsList = projectWrapper.querySelector('.searchable-select-options');
            if (optionsList) {
                renderFilteredProjectOptions(projectSelect, optionsList, selectedLabId);
            }
        }
    }
    
    function renderFilteredProjectOptions(select, optionsList, selectedLabId) {
        optionsList.innerHTML = '';
        
        Array.from(select.options).forEach(opt => {
            // Skip disabled/hidden options (filtered by lab)
            if (opt.disabled && opt.value !== '') return;
            
            const optionDiv = document.createElement('div');
            optionDiv.className = 'searchable-option';
            optionDiv.dataset.value = opt.value;
            optionDiv.textContent = opt.text;
            
            if (opt.value === select.value) {
                optionDiv.classList.add('selected');
            }
            
            optionDiv.addEventListener('click', () => {
                select.value = opt.value;
                select.dispatchEvent(new Event('change'));
                const wrapper = select.closest('.searchable-select-wrapper');
                if (wrapper) {
                    wrapper.querySelector('.selected-text').textContent = opt.text;
                    wrapper.classList.remove('open');
                }
            });
            
            optionsList.appendChild(optionDiv);
        });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateProjectOptions();
        
        // Hamburger menu functionality
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const navDrawer = document.getElementById('nav-drawer');
        const navOverlay = document.getElementById('nav-overlay');
        const navDrawerClose = document.getElementById('nav-drawer-close');
        
        function openDrawer() {
            navDrawer.classList.add('open');
            navOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeDrawer() {
            navDrawer.classList.remove('open');
            navOverlay.classList.remove('open');
            document.body.style.overflow = '';
        }
        
        hamburgerBtn.addEventListener('click', openDrawer);
        navOverlay.addEventListener('click', closeDrawer);
        navDrawerClose.addEventListener('click', closeDrawer);
        
        // Filter row toggle functionality
        const filterToggleBtn = document.getElementById('filter-toggle-btn');
        const filterRow = document.getElementById('filter-bar');
        const filterRowClose = document.getElementById('filter-row-close');
        
        filterToggleBtn.addEventListener('click', function() {
            filterRow.classList.toggle('collapsed');
            filterToggleBtn.classList.toggle('filter-open');
        });
        
        filterRowClose.addEventListener('click', function() {
            filterRow.classList.add('collapsed');
            filterToggleBtn.classList.remove('filter-open');
        });
        
        // Click outside filter row to close it
        document.addEventListener('click', function(e) {
            // If filter bar is open and click is outside both filter bar and toggle button
            if (!filterRow.classList.contains('collapsed') && 
                !filterRow.contains(e.target) && 
                !filterToggleBtn.contains(e.target)) {
                filterRow.classList.add('collapsed');
                filterToggleBtn.classList.remove('filter-open');
            }
        });
    });
    </script>
    
    <!-- Custom Modal System -->
    <style>
    .pybirch-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.2s ease, visibility 0.2s ease;
    }
    .pybirch-modal-overlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }
    .pybirch-modal {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 420px;
        width: 90%;
        transform: scale(0.9);
        transition: transform 0.2s ease;
        border: 1px solid #e2e8f0;
    }
    .pybirch-modal-overlay.show .pybirch-modal {
        transform: scale(1);
    }
    .pybirch-modal-header {
        padding: 20px 24px 16px;
        border-bottom: 1px solid #e2e8f0;
    }
    .pybirch-modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .pybirch-modal-header .modal-icon {
        font-size: 1.5rem;
    }
    .pybirch-modal-header.danger h3 {
        color: #dc2626;
    }
    .pybirch-modal-header.success h3 {
        color: #16a34a;
    }
    .pybirch-modal-header.warning h3 {
        color: #d97706;
    }
    .pybirch-modal-body {
        padding: 20px 24px;
        color: #475569;
        line-height: 1.6;
    }
    .pybirch-modal-body p {
        margin: 0 0 12px;
    }
    .pybirch-modal-body p:last-child {
        margin-bottom: 0;
    }
    .pybirch-modal-body strong {
        color: #1e293b;
    }
    .pybirch-modal-body .info-text {
        font-size: 0.9rem;
        color: #64748b;
        background: #f8fafc;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
        border: 1px solid #e2e8f0;
    }
    .pybirch-modal-footer {
        padding: 16px 24px 20px;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
        border-radius: 0 0 12px 12px;
    }
    .pybirch-modal-btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s ease;
    }
    .pybirch-modal-btn-secondary {
        background: #ffffff;
        color: #475569;
        border: 1px solid #cbd5e1;
    }
    .pybirch-modal-btn-secondary:hover {
        background: #f1f5f9;
        border-color: #94a3b8;
    }
    .pybirch-modal-btn-primary {
        background: #3b82f6;
        color: white;
    }
    .pybirch-modal-btn-primary:hover {
        background: #2563eb;
    }
    .pybirch-modal-btn-danger {
        background: #ef4444;
        color: white;
    }
    .pybirch-modal-btn-danger:hover {
        background: #dc2626;
    }
    .pybirch-modal-btn-success {
        background: #22c55e;
        color: white;
    }
    .pybirch-modal-btn-success:hover {
        background: #16a34a;
    }
    </style>
    
    <!-- Trash Management Functions -->
    <script>
    // Custom Modal System
    const PyBirchModal = {
        _overlay: null,
        
        _createOverlay() {
            if (this._overlay) return this._overlay;
            
            this._overlay = document.createElement('div');
            this._overlay.className = 'pybirch-modal-overlay';
            this._overlay.innerHTML = `
                <div class="pybirch-modal">
                    <div class="pybirch-modal-header">
                        <h3><span class="modal-icon"></span><span class="modal-title"></span></h3>
                    </div>
                    <div class="pybirch-modal-body"></div>
                    <div class="pybirch-modal-footer"></div>
                </div>
            `;
            document.body.appendChild(this._overlay);
            
            // Close on overlay click
            this._overlay.addEventListener('click', (e) => {
                if (e.target === this._overlay) this.close();
            });
            
            // Close on Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this._overlay.classList.contains('show')) {
                    this.close();
                }
            });
            
            return this._overlay;
        },
        
        show(options) {
            const overlay = this._createOverlay();
            const modal = overlay.querySelector('.pybirch-modal');
            const header = modal.querySelector('.pybirch-modal-header');
            const icon = modal.querySelector('.modal-icon');
            const title = modal.querySelector('.modal-title');
            const body = modal.querySelector('.pybirch-modal-body');
            const footer = modal.querySelector('.pybirch-modal-footer');
            
            // Set header type
            header.className = 'pybirch-modal-header ' + (options.type || '');
            
            // Set icon
            const icons = {
                danger: 'üóëÔ∏è',
                warning: '‚ö†Ô∏è',
                success: '‚úÖ',
                info: '‚ÑπÔ∏è'
            };
            icon.textContent = options.icon || icons[options.type] || '';
            
            // Set title and body
            title.textContent = options.title || 'Confirm';
            body.innerHTML = options.body || '';
            
            // Set buttons
            footer.innerHTML = '';
            (options.buttons || []).forEach(btn => {
                const button = document.createElement('button');
                button.className = `pybirch-modal-btn pybirch-modal-btn-${btn.type || 'secondary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    if (btn.action) btn.action();
                    if (btn.close !== false) this.close();
                };
                footer.appendChild(button);
            });
            
            // Show modal
            requestAnimationFrame(() => {
                overlay.classList.add('show');
            });
            
            return this;
        },
        
        close() {
            if (this._overlay) {
                this._overlay.classList.remove('show');
            }
        },
        
        confirm(options) {
            return new Promise((resolve) => {
                this.show({
                    type: options.type || 'warning',
                    icon: options.icon,
                    title: options.title || 'Confirm',
                    body: options.body || 'Are you sure?',
                    buttons: [
                        {
                            text: options.cancelText || 'Cancel',
                            type: 'secondary',
                            action: () => resolve(false)
                        },
                        {
                            text: options.confirmText || 'Confirm',
                            type: options.confirmType || 'primary',
                            action: () => resolve(true)
                        }
                    ]
                });
            });
        },
        
        alert(options) {
            return new Promise((resolve) => {
                this.show({
                    type: options.type || 'info',
                    icon: options.icon,
                    title: options.title || 'Notice',
                    body: options.body || '',
                    buttons: [
                        {
                            text: options.buttonText || 'OK',
                            type: options.type === 'danger' ? 'danger' : (options.type === 'success' ? 'success' : 'primary'),
                            action: () => resolve(true)
                        }
                    ]
                });
            });
        }
    };
    
    // Alias for backwards compatibility with action_buttons macro
    function trashItem(entityType, entityId, entityName) {
        return moveToTrash(entityType, entityId, entityName);
    }
    
    async function moveToTrash(entityType, entityId, entityName) {
        const name = entityName || `#${entityId}`;
        const typeName = entityType.replace(/_/g, ' ');
        
        const confirmed = await PyBirchModal.confirm({
            type: 'danger',
            title: 'Move to Trash',
            body: `
                <p>Are you sure you want to move <strong>"${name}"</strong> to trash?</p>
                <div class="info-text">
                    üí° You can restore this ${typeName} from the Trash page within 30 days.
                </div>
            `,
            cancelText: 'Cancel',
            confirmText: 'Move to Trash',
            confirmType: 'danger'
        });
        
        if (!confirmed) return false;
        
        const url = `/api/trash/${entityType}/${entityId}`;
        console.log('Trash API URL:', url);
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ cascade: true })
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', [...response.headers.entries()]);
            
            // Get response text first to debug
            const responseText = await response.text();
            console.log('Response text (first 500 chars):', responseText.substring(0, 500));
            
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Not JSON - likely a redirect or HTML error page
                if (response.status === 401 || response.redirected) {
                    await PyBirchModal.alert({
                        type: 'danger',
                        title: 'Authentication Required',
                        body: `<p>Please log in to perform this action.</p>`,
                        buttonText: 'OK'
                    });
                    window.location.href = '/login';
                    return false;
                }
                throw new Error(`Server returned non-JSON response (status: ${response.status}, content-type: ${contentType})`);
            }
            
            // Parse the text as JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                console.error('Response was:', responseText);
                throw new Error(`Invalid JSON response: ${parseError.message}`);
            }
            
            if (response.ok) {
                await PyBirchModal.alert({
                    type: 'success',
                    title: 'Moved to Trash',
                    body: `<p><strong>"${name}"</strong> has been moved to trash.</p>
                           <div class="info-text">You can restore it from the Trash page within 30 days.</div>`,
                    buttonText: 'OK'
                });
                window.location.href = `/${entityType}s`;
                return true;
            } else {
                await PyBirchModal.alert({
                    type: 'danger',
                    title: 'Error',
                    body: `<p>${data.error || 'Failed to move item to trash.'}</p>`,
                    buttonText: 'OK'
                });
                return false;
            }
        } catch (error) {
            console.error('Trash error:', error);
            await PyBirchModal.alert({
                type: 'danger',
                title: 'Error',
                body: `<p>Failed to move item to trash.</p>
                       <div class="info-text">Error: ${error.message}<br><br>Check browser console (F12) for details.</div>`,
                buttonText: 'OK'
            });
            return false;
        }
    }
    
    async function restoreFromTrash(entityType, entityId, entityName) {
        const name = entityName || `#${entityId}`;
        
        try {
            const response = await fetch(`/api/trash/${entityType}/${entityId}/restore`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return true;
            } else {
                await PyBirchModal.alert({
                    type: 'danger',
                    title: 'Error',
                    body: `<p>${data.error || 'Failed to restore item.'}</p>`,
                    buttonText: 'OK'
                });
                return false;
            }
        } catch (error) {
            console.error('Restore error:', error);
            await PyBirchModal.alert({
                type: 'danger',
                title: 'Error',
                body: `<p>Failed to restore item. Please try again.</p>`,
                buttonText: 'OK'
            });
            return false;
        }
    }
    
    async function permanentDelete(entityType, entityId, entityName) {
        const name = entityName || `#${entityId}`;
        
        const confirmed = await PyBirchModal.confirm({
            type: 'danger',
            title: 'Permanent Delete',
            body: `
                <p>Are you sure you want to <strong>permanently delete</strong> "${name}"?</p>
                <div class="info-text" style="background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444;">
                    ‚ö†Ô∏è This action cannot be undone. The item will be permanently removed.
                </div>
            `,
            cancelText: 'Cancel',
            confirmText: 'Delete Forever',
            confirmType: 'danger'
        });
        
        if (!confirmed) return false;
        
        try {
            const response = await fetch(`/api/trash/${entityType}/${entityId}`, {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return true;
            } else {
                await PyBirchModal.alert({
                    type: 'danger',
                    title: 'Error',
                    body: `<p>${data.error || 'Failed to delete item.'}</p>`,
                    buttonText: 'OK'
                });
                return false;
            }
        } catch (error) {
            console.error('Delete error:', error);
            await PyBirchModal.alert({
                type: 'danger',
                title: 'Error',
                body: `<p>Failed to delete item. Please try again.</p>`,
                buttonText: 'OK'
            });
            return false;
        }
    }
    
    // ==================== Archive Management Functions ====================
    
    async function archiveItem(entityType, entityId, entityName) {
        const name = entityName || `#${entityId}`;
        const typeName = entityType.replace(/_/g, ' ');
        
        const confirmed = await PyBirchModal.confirm({
            type: 'warning',
            icon: 'üì¶',
            title: 'Archive Item',
            body: `
                <p>Are you sure you want to archive <strong>"${name}"</strong>?</p>
                <div class="info-text">
                    üì¶ Archived items are hidden from normal views but preserved indefinitely.
                    You can unarchive from the Archive page anytime.
                </div>
            `,
            cancelText: 'Cancel',
            confirmText: 'Archive',
            confirmType: 'primary'
        });
        
        if (!confirmed) return false;
        
        try {
            const response = await fetch(`/api/archive/${entityType}/${entityId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            
            const responseText = await response.text();
            const contentType = response.headers.get('content-type');
            
            if (!contentType || !contentType.includes('application/json')) {
                if (response.status === 401 || responseText.includes('login')) {
                    await PyBirchModal.alert({
                        type: 'warning',
                        title: 'Session Expired',
                        body: '<p>Your session has expired. Please log in again.</p>',
                        buttonText: 'OK'
                    });
                    window.location.href = '/login';
                    return false;
                }
                throw new Error(`Server returned non-JSON response`);
            }
            
            const data = JSON.parse(responseText);
            
            if (response.ok) {
                await PyBirchModal.alert({
                    type: 'success',
                    title: 'Archived',
                    body: `<p><strong>"${name}"</strong> has been archived.</p>
                           <div class="info-text">You can restore it from the <a href="/archive">Archive page</a> anytime.</div>`,
                    buttonText: 'OK'
                });
                window.location.href = `/${entityType}s`;
                return true;
            } else {
                await PyBirchModal.alert({
                    type: 'danger',
                    title: 'Error',
                    body: `<p>${data.error || 'Failed to archive item.'}</p>`,
                    buttonText: 'OK'
                });
                return false;
            }
        } catch (error) {
            console.error('Archive error:', error);
            await PyBirchModal.alert({
                type: 'danger',
                title: 'Error',
                body: `<p>Failed to archive item. Please try again.</p>`,
                buttonText: 'OK'
            });
            return false;
        }
    }
    
    async function unarchiveItem(entityType, entityId, entityName) {
        const name = entityName || `#${entityId}`;
        
        try {
            const response = await fetch(`/api/archive/${entityType}/${entityId}/unarchive`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return true;
            } else {
                await PyBirchModal.alert({
                    type: 'danger',
                    title: 'Error',
                    body: `<p>${data.error || 'Failed to unarchive item.'}</p>`,
                    buttonText: 'OK'
                });
                return false;
            }
        } catch (error) {
            console.error('Unarchive error:', error);
            await PyBirchModal.alert({
                type: 'danger',
                title: 'Error',
                body: `<p>Failed to unarchive item. Please try again.</p>`,
                buttonText: 'OK'
            });
            return false;
        }
    }
    </script>
    
    <!-- PyBirch Real-Time WebSocket Client -->
    <script src="{{ url_for('static', filename='js/pybirch-realtime.js') }}"></script>
    <script>
        // Initialize real-time client on page load
        document.addEventListener('DOMContentLoaded', function() {
            const realtime = initPyBirchRealtime();
            realtime.connect();
            
            // Log connection status changes for debugging
            realtime.onConnect(function() {
                console.log('PyBirch Realtime connected');
            });
            realtime.onDisconnect(function(data) {
                console.log('PyBirch Realtime disconnected:', data.reason);
            });
        });
    </script>
    
    <!-- Page Time Tracking -->
    <script>
        (function() {
            const pageLoadTime = Date.now();
            let durationSent = false;
            
            function sendPageDuration() {
                // Only send once per page load
                if (durationSent) return;
                
                // Need page view ID to update
                const pageViewId = window.__PAGE_VIEW_ID__;
                if (!pageViewId) return;
                
                durationSent = true;
                const duration = Math.floor((Date.now() - pageLoadTime) / 1000);
                
                // Use sendBeacon for reliable delivery on page unload
                const payload = JSON.stringify({ page_view_id: pageViewId, duration: duration });
                
                if (navigator.sendBeacon) {
                    const blob = new Blob([payload], { type: 'application/json' });
                    navigator.sendBeacon('/api/track/page-duration', blob);
                } else {
                    // Fallback for older browsers
                    fetch('/api/track/page-duration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: payload,
                        keepalive: true
                    }).catch(() => {});
                }
            }
            
            // Send duration when user leaves the page
            window.addEventListener('pagehide', sendPageDuration);
            window.addEventListener('beforeunload', sendPageDuration);
            
            // Also send on visibility change (tab switch)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    sendPageDuration();
                }
            });
        })();
    </script>
    
    <!-- Theme System -->
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
