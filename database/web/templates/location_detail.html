{% extends "base.html" %}
{% from "macros.html" import action_buttons, detail_action_buttons, icon_trash, icon_edit %}

{% block title %}{{ location.name }} - PyBirch Database{% endblock %}

{% block content %}
<div class="detail-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.locations') }}">Locations</a>
            {% if location.parent_path %}
                {% for parent in location.parent_path %}
                / <a href="{{ url_for('main.location_detail', location_id=parent.id) }}">{{ parent.name }}</a>
                {% endfor %}
            {% endif %}
            / {{ location.name }}
        </div>
    </div>
    
    <div class="detail-header">
        <h1>{{ location.name }}</h1>
        <div class="detail-actions">
            <span class="type-badge">{{ location.location_type or 'Unknown' }}</span>
            <a href="{{ url_for('main.location_new', parent_id=location.id) }}" class="btn btn-secondary">+ Add Child</a>
            {{ detail_action_buttons(
                edit_url=url_for('main.location_edit', location_id=location.id),
                duplicate_url=url_for('main.location_duplicate', location_id=location.id),
                entity_type='location',
                entity_id=location.id,
                show_archive=false
            ) }}
        </div>
    </div>
    
    <!-- QR Code Section -->
    <div class="qr-code-section">
        <div class="qr-code-preview">
            <img src="{{ url_for('main.location_qrcode_preview', location_id=location.id) }}" 
                 alt="QR Code for {{ location.name }}" 
                 class="qr-code-img">
        </div>
        <a href="{{ url_for('main.location_qrcode', location_id=location.id) }}" 
           class="btn btn-secondary btn-small" download>
            ðŸ“¥ Download QR Code
        </a>
    </div>
    
    <div class="detail-grid">
        <div class="detail-section">
            <h2>Location Information</h2>
            <dl class="detail-list">
                <dt>Description</dt>
                <dd>{{ location.description or '-' }}</dd>
                
                <dt>Type</dt>
                <dd>{{ location.location_type or '-' }}</dd>
                
                <dt>Lab</dt>
                <dd>
                    {% if location.lab_id %}
                    <a href="{{ url_for('main.lab_detail', lab_id=location.lab_id) }}">{{ location.lab_name }}</a>
                    {% else %}
                    -
                    {% endif %}
                </dd>
                
                <dt>Parent Location</dt>
                <dd>
                    {% if location.parent_location_id %}
                    <a href="{{ url_for('main.location_detail', location_id=location.parent_location_id) }}">{{ location.parent_name }}</a>
                    {% else %}
                    (Top-level location)
                    {% endif %}
                </dd>
                
                <dt>Room Number</dt>
                <dd>{{ location.room_number or '-' }}</dd>
                
                <dt>Building</dt>
                <dd>{{ location.building or '-' }}</dd>
                
                <dt>Floor</dt>
                <dd>{{ location.floor or '-' }}</dd>
                
                <dt>Capacity</dt>
                <dd>{{ location.capacity or '-' }}</dd>
                
                <dt>Created</dt>
                <dd>{{ location.created_at[:10] if location.created_at else '-' }}{% if location.created_by %} by {{ location.created_by }}{% endif %}</dd>
            </dl>
        </div>
        
        <div class="detail-section">
            <h2>Conditions & Access</h2>
            <dl class="detail-list">
                <dt>Conditions</dt>
                <dd>{{ location.conditions or '-' }}</dd>
                
                <dt>Access Notes</dt>
                <dd>{{ location.access_notes or '-' }}</dd>
            </dl>
        </div>
    </div>
    
    <!-- Child Locations Section -->
    {% if location.child_locations %}
    <div class="detail-section full-width">
        <h2>Child Locations</h2>
        <p class="section-description">Sub-locations within this location (e.g., drawers in a cabinet).</p>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Objects</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for child in location.child_locations %}
                <tr>
                    <td><a href="{{ url_for('main.location_detail', location_id=child.id) }}">{{ child.name }}</a></td>
                    <td><span class="type-badge">{{ child.location_type or '-' }}</span></td>
                    <td>{{ child.object_count or 0 }}</td>
                    <td>
                        {{ action_buttons(
                            view_url=url_for('main.location_detail', location_id=child.id),
                            edit_url=url_for('main.location_edit', location_id=child.id),
                            entity_type='location',
                            entity_id=child.id
                        ) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <!-- Objects at this Location Section -->
    <div class="detail-section full-width">
        <h2>Objects at this Location</h2>
        <p class="section-description">Physical items currently stored or located here.</p>
        
        {% set objects = location.objects or {} %}
        {% set has_objects = objects.equipment or objects.instruments or objects.samples or objects.precursors or objects.computers %}
        
        {% if has_objects %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Object Type</th>
                    <th>Name</th>
                    <th>Notes/Directions</th>
                    <th>Placed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for obj in objects.equipment or [] %}
                <tr>
                    <td><span class="type-badge">Equipment</span></td>
                    <td><a href="{{ url_for('main.equipment_detail', equipment_id=obj.object_id) }}">{{ obj.name }}</a></td>
                    <td>
                        <span class="notes-display" data-type="equipment" data-id="{{ obj.object_id }}">{{ obj.notes or '-' }}</span>
                        <form method="POST" action="{{ url_for('main.location_update_object_notes', location_id=location.id) }}" class="notes-edit-form" style="display: none;" data-type="equipment" data-id="{{ obj.object_id }}">
                            <input type="hidden" name="object_type" value="equipment">
                            <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                            <input type="text" name="notes" value="{{ obj.notes or '' }}" class="filter-input" style="width: 200px;">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-link cancel-edit">Cancel</button>
                        </form>
                    </td>
                    <td>{{ obj.placed_at[:10] if obj.placed_at else '-' }}{% if obj.placed_by %} by {{ obj.placed_by }}{% endif %}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-icon-edit edit-notes-btn" data-type="equipment" data-id="{{ obj.object_id }}" title="Edit notes">
                                {{ icon_edit() }}
                            </button>
                            <form method="POST" action="{{ url_for('main.location_remove_object', location_id=location.id) }}" style="display: inline;">
                                <input type="hidden" name="object_type" value="equipment">
                                <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                                <button type="submit" class="btn-icon btn-icon-trash" title="Remove" onclick="return confirm('Remove this object from location?')">
                                    {{ icon_trash() }}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for obj in objects.instruments or [] %}
                <tr>
                    <td><span class="type-badge">Instrument</span></td>
                    <td><a href="{{ url_for('main.instrument_detail', instrument_id=obj.object_id) }}">{{ obj.name }}</a></td>
                    <td>
                        <span class="notes-display" data-type="instrument" data-id="{{ obj.object_id }}">{{ obj.notes or '-' }}</span>
                        <form method="POST" action="{{ url_for('main.location_update_object_notes', location_id=location.id) }}" class="notes-edit-form" style="display: none;" data-type="instrument" data-id="{{ obj.object_id }}">
                            <input type="hidden" name="object_type" value="instrument">
                            <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                            <input type="text" name="notes" value="{{ obj.notes or '' }}" class="filter-input" style="width: 200px;">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-link cancel-edit">Cancel</button>
                        </form>
                    </td>
                    <td>{{ obj.placed_at[:10] if obj.placed_at else '-' }}{% if obj.placed_by %} by {{ obj.placed_by }}{% endif %}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-icon-edit edit-notes-btn" data-type="instrument" data-id="{{ obj.object_id }}" title="Edit notes">
                                {{ icon_edit() }}
                            </button>
                            <form method="POST" action="{{ url_for('main.location_remove_object', location_id=location.id) }}" style="display: inline;">
                                <input type="hidden" name="object_type" value="instrument">
                                <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                                <button type="submit" class="btn-icon btn-icon-trash" title="Remove" onclick="return confirm('Remove this object from location?')">
                                    {{ icon_trash() }}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for obj in objects.samples or [] %}
                <tr>
                    <td><span class="type-badge">Sample</span></td>
                    <td><a href="{{ url_for('main.sample_detail', sample_id=obj.object_id) }}">{{ obj.name }}</a></td>
                    <td>
                        <span class="notes-display" data-type="sample" data-id="{{ obj.object_id }}">{{ obj.notes or '-' }}</span>
                        <form method="POST" action="{{ url_for('main.location_update_object_notes', location_id=location.id) }}" class="notes-edit-form" style="display: none;" data-type="sample" data-id="{{ obj.object_id }}">
                            <input type="hidden" name="object_type" value="sample">
                            <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                            <input type="text" name="notes" value="{{ obj.notes or '' }}" class="filter-input" style="width: 200px;">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-link cancel-edit">Cancel</button>
                        </form>
                    </td>
                    <td>{{ obj.placed_at[:10] if obj.placed_at else '-' }}{% if obj.placed_by %} by {{ obj.placed_by }}{% endif %}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-icon-edit edit-notes-btn" data-type="sample" data-id="{{ obj.object_id }}" title="Edit notes">
                                {{ icon_edit() }}
                            </button>
                            <form method="POST" action="{{ url_for('main.location_remove_object', location_id=location.id) }}" style="display: inline;">
                                <input type="hidden" name="object_type" value="sample">
                                <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                                <button type="submit" class="btn-icon btn-icon-trash" title="Remove" onclick="return confirm('Remove this object from location?')">
                                    {{ icon_trash() }}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for obj in objects.precursors or [] %}
                <tr>
                    <td><span class="type-badge">Precursor</span></td>
                    <td><a href="{{ url_for('main.precursor_detail', precursor_id=obj.object_id) }}">{{ obj.name }}</a></td>
                    <td>
                        <span class="notes-display" data-type="precursor" data-id="{{ obj.object_id }}">{{ obj.notes or '-' }}</span>
                        <form method="POST" action="{{ url_for('main.location_update_object_notes', location_id=location.id) }}" class="notes-edit-form" style="display: none;" data-type="precursor" data-id="{{ obj.object_id }}">
                            <input type="hidden" name="object_type" value="precursor">
                            <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                            <input type="text" name="notes" value="{{ obj.notes or '' }}" class="filter-input" style="width: 200px;">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-link cancel-edit">Cancel</button>
                        </form>
                    </td>
                    <td>{{ obj.placed_at[:10] if obj.placed_at else '-' }}{% if obj.placed_by %} by {{ obj.placed_by }}{% endif %}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-icon-edit edit-notes-btn" data-type="precursor" data-id="{{ obj.object_id }}" title="Edit notes">
                                {{ icon_edit() }}
                            </button>
                            <form method="POST" action="{{ url_for('main.location_remove_object', location_id=location.id) }}" style="display: inline;">
                                <input type="hidden" name="object_type" value="precursor">
                                <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                                <button type="submit" class="btn-icon btn-icon-trash" title="Remove" onclick="return confirm('Remove this object from location?')">
                                    {{ icon_trash() }}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% for obj in objects.computers or [] %}
                <tr>
                    <td><span class="type-badge">Computer</span></td>
                    <td><a href="{{ url_for('main.computer_detail', computer_id=obj.object_id) }}">{{ obj.name }}</a></td>
                    <td>
                        <span class="notes-display" data-type="computer" data-id="{{ obj.object_id }}">{{ obj.notes or '-' }}</span>
                        <form method="POST" action="{{ url_for('main.location_update_object_notes', location_id=location.id) }}" class="notes-edit-form" style="display: none;" data-type="computer" data-id="{{ obj.object_id }}">
                            <input type="hidden" name="object_type" value="computer">
                            <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                            <input type="text" name="notes" value="{{ obj.notes or '' }}" class="filter-input" style="width: 200px;">
                            <button type="submit" class="btn btn-sm btn-primary">Save</button>
                            <button type="button" class="btn btn-sm btn-link cancel-edit">Cancel</button>
                        </form>
                    </td>
                    <td>{{ obj.placed_at[:10] if obj.placed_at else '-' }}{% if obj.placed_by %} by {{ obj.placed_by }}{% endif %}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-icon-edit edit-notes-btn" data-type="computer" data-id="{{ obj.object_id }}" title="Edit notes">
                                {{ icon_edit() }}
                            </button>
                            <form method="POST" action="{{ url_for('main.location_remove_object', location_id=location.id) }}" style="display: inline;">
                                <input type="hidden" name="object_type" value="computer">
                                <input type="hidden" name="object_id" value="{{ obj.object_id }}">
                                <button type="submit" class="btn-icon btn-icon-trash" title="Remove" onclick="return confirm('Remove this object from location?')">
                                    {{ icon_trash() }}
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-message">No objects currently at this location.</p>
        {% endif %}
        
        <!-- Add Object Form -->
        {% if current_user %}
        <div class="add-object-form" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
            <h3>Add Object to Location</h3>
            <form method="POST" action="{{ url_for('main.location_add_object', location_id=location.id) }}" class="inline-form" id="add-object-form">
                <div class="form-grid" style="grid-template-columns: 150px 300px 1fr auto; gap: 0.5rem; align-items: start;">
                    <div class="form-group" style="margin: 0;">
                        <label for="add-object-type" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Type</label>
                        <select name="object_type" required class="searchable-select" id="add-object-type" style="width: 100%;">
                            <option value="">Select Type...</option>
                            <option value="equipment">Equipment</option>
                            <option value="instrument">Instrument</option>
                            <option value="sample">Sample</option>
                            <option value="precursor">Precursor</option>
                            <option value="computer">Computer</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;" id="object-select-container">
                        <label for="add-object-id" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Object</label>
                        <select name="object_id" required id="add-object-id" style="width: 100%;">
                            <option value="">Select type first...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label for="add-object-notes" style="font-size: 0.85rem; margin-bottom: 0.25rem;">Notes/Directions</label>
                        <input type="text" name="notes" id="add-object-notes" placeholder="e.g., 'in the blue bottle'" class="filter-input" style="width: 100%;">
                    </div>
                    <div class="form-group" style="margin: 0; padding-top: 1.5rem;">
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Hidden data for object lists -->
        <script id="equipment-data" type="application/json">{{ equipment_list | tojson }}</script>
        <script id="instruments-data" type="application/json">{{ instruments_list | tojson }}</script>
        <script id="samples-data" type="application/json">{{ samples_list | tojson }}</script>
        <script id="precursors-data" type="application/json">{{ precursors_list | tojson }}</script>
        <script id="computers-data" type="application/json">{{ computers_list | tojson }}</script>
        {% endif %}
    </div>
    
    <!-- Images Section -->
    {% include 'partials/image_gallery.html' %}
    
    <!-- Files Section -->
    {% include 'partials/file_gallery.html' %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit notes functionality
    document.querySelectorAll('.edit-notes-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const type = this.dataset.type;
            const id = this.dataset.id;
            const display = document.querySelector(`.notes-display[data-type="${type}"][data-id="${id}"]`);
            const form = document.querySelector(`.notes-edit-form[data-type="${type}"][data-id="${id}"]`);
            if (display && form) {
                display.style.display = 'none';
                form.style.display = 'flex';
                form.style.gap = '0.5rem';
                form.style.alignItems = 'center';
                form.querySelector('input[name="notes"]').focus();
            }
        });
    });
    
    document.querySelectorAll('.cancel-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const form = this.closest('.notes-edit-form');
            const type = form.dataset.type;
            const id = form.dataset.id;
            const display = document.querySelector(`.notes-display[data-type="${type}"][data-id="${id}"]`);
            if (display && form) {
                form.style.display = 'none';
                display.style.display = 'inline';
            }
        });
    });
    
    const typeSelect = document.getElementById('add-object-type');
    const objectSelectContainer = document.getElementById('object-select-container');
    
    if (!typeSelect || !objectSelectContainer) return;
    
    // Load data from hidden script tags
    function loadData(elementId) {
        const el = document.getElementById(elementId);
        if (!el) return [];
        try {
            return JSON.parse(el.textContent);
        } catch (e) {
            console.error('Error parsing', elementId, e);
            return [];
        }
    }
    
    const objectData = {
        equipment: loadData('equipment-data'),
        instrument: loadData('instruments-data'),
        sample: loadData('samples-data'),
        precursor: loadData('precursors-data'),
        computer: loadData('computers-data')
    };
    
    function getDisplayName(item, type) {
        if (type === 'equipment') {
            return item.name + (item.equipment_type ? ' (' + item.equipment_type + ')' : '');
        } else if (type === 'instrument') {
            return item.name + (item.instrument_type ? ' (' + item.instrument_type + ')' : '');
        } else if (type === 'sample') {
            return (item.sample_id || '') + ' - ' + (item.name || item.material || 'Unnamed');
        } else if (type === 'precursor') {
            return item.name + (item.formula ? ' (' + item.formula + ')' : '');
        } else if (type === 'computer') {
            return item.name || item.hostname || 'Computer ' + item.id;
        }
        return item.name || 'Item ' + item.id;
    }
    
    function updateObjectOptions(type) {
        // Remove existing wrapper if present
        const existingWrapper = objectSelectContainer.querySelector('.searchable-select-wrapper');
        if (existingWrapper) {
            existingWrapper.remove();
        }
        
        // Remove any existing plain select (not inside wrapper)
        const existingSelect = objectSelectContainer.querySelector('select#add-object-id');
        if (existingSelect) {
            existingSelect.remove();
        }
        
        // Create fresh select element
        const objectSelect = document.createElement('select');
        objectSelect.name = 'object_id';
        objectSelect.required = true;
        objectSelect.id = 'add-object-id';
        objectSelect.style.width = '100%';
        objectSelect.dataset.entityType = type || '';
        
        // Add placeholder option
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = type ? 'Select ' + type + '...' : 'Select type first...';
        objectSelect.appendChild(placeholder);
        
        // Add options if type is selected
        if (type && objectData[type]) {
            objectSelect.classList.add('searchable-select');
            const items = objectData[type];
            items.forEach(function(item) {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = getDisplayName(item, type);
                objectSelect.appendChild(option);
            });
        }
        
        // Append new select to container
        objectSelectContainer.appendChild(objectSelect);
        
        // Initialize searchable-select if type is selected
        if (type && objectData[type] && typeof initSearchableSelects === 'function') {
            initSearchableSelects();
        }
    }
    
    // Handle type selection change - use a custom event handler for searchable-select
    function handleTypeChange(value) {
        updateObjectOptions(value);
    }
    
    // Check for searchable-select wrapper (type select gets initialized by main.js)
    const typeWrapper = typeSelect.closest('.searchable-select-wrapper');
    if (typeWrapper) {
        // The type select is already a searchable-select, listen to the underlying select
        typeSelect.addEventListener('change', function() {
            handleTypeChange(this.value);
        });
    } else {
        // Fallback for when searchable-select isn't initialized yet
        typeSelect.addEventListener('change', function() {
            handleTypeChange(this.value);
        });
    }
    
    // Initialize with empty state
    updateObjectOptions('');
});
</script>
{% endblock %}
