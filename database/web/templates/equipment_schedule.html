{% extends "base.html" %}
{% from "macros.html" import icon_settings, icon_plus %}

{% block title %}{{ equipment.name }} - Schedule - PyBirch Database{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .calendar-container {
        background-color: var(--color-bg-primary);
        border-radius: var(--border-radius);
        padding: 1.25rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
    }
    
    .fc {
        --fc-border-color: var(--color-border);
        --fc-button-bg-color: var(--color-primary);
        --fc-button-border-color: var(--color-primary);
        --fc-button-hover-bg-color: var(--color-primary-dark);
        --fc-button-hover-border-color: var(--color-primary-dark);
        --fc-button-active-bg-color: var(--color-primary-dark);
        --fc-today-bg-color: rgba(0, 120, 212, 0.1);
        --fc-event-bg-color: var(--color-primary);
        --fc-event-border-color: var(--color-primary);
        --fc-page-bg-color: var(--color-bg-primary);
        --fc-neutral-bg-color: var(--color-bg-secondary);
        --fc-list-event-hover-bg-color: var(--color-bg-tertiary);
    }
    
    .fc .fc-daygrid-day-number,
    .fc .fc-col-header-cell-cushion,
    .fc .fc-timegrid-slot-label-cushion,
    .fc .fc-timegrid-axis-cushion {
        color: var(--color-text-primary);
    }
    
    .fc .fc-toolbar-title {
        color: var(--color-text-primary);
    }
    
    .fc .fc-button {
        font-size: 0.875rem;
    }
    
    .fc .fc-daygrid-day.fc-day-today,
    .fc .fc-timegrid-col.fc-day-today {
        background-color: var(--fc-today-bg-color);
    }
    
    .fc-theme-standard td,
    .fc-theme-standard th {
        border-color: var(--color-border);
    }
    
    .fc-theme-standard .fc-scrollgrid {
        border-color: var(--color-border);
    }
    
    .booking-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background-color: var(--color-bg-primary);
        border-radius: var(--border-radius);
        margin-bottom: 0.5rem;
        border-left: 4px solid var(--color-primary);
        box-shadow: var(--shadow-sm);
    }
    
    .booking-card .time {
        font-weight: 600;
        min-width: 140px;
        color: var(--color-text-primary);
    }
    
    .booking-card .details {
        flex: 1;
    }
    
    .booking-card .status-badge {
        font-size: 0.75rem;
    }
    
    .ical-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }
    
    .ical-link:hover {
        color: var(--color-primary);
    }
    
    /* Booking Modal Styles */
    .booking-modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .booking-modal-overlay.active {
        display: flex;
    }
    
    .booking-modal {
        background: var(--color-bg-primary);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        width: 100%;
        max-width: 450px;
        box-shadow: var(--shadow-lg);
    }
    
    .booking-modal h2 {
        margin: 0 0 1rem;
        font-size: 1.25rem;
    }
    
    .booking-modal-times {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .booking-modal-times .form-group {
        margin-bottom: 0.5rem;
    }
    
    .booking-modal-times label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--color-text-secondary);
        margin-bottom: 0.25rem;
    }
    
    .booking-modal-times input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius-sm);
        font-size: 0.875rem;
    }
    
    .booking-modal-duration {
        text-align: center;
        padding: 0.75rem;
        background: var(--color-bg-secondary);
        border-radius: var(--border-radius-sm);
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }
    
    .booking-modal-conflict {
        padding: 0.75rem;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--border-radius-sm);
        margin-bottom: 1rem;
        color: #dc2626;
        font-size: 0.875rem;
    }
    
    .booking-modal-conflict.hidden {
        display: none;
    }
    
    .booking-modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
    }
    
    /* Selection highlighting */
    .fc .fc-highlight {
        background: rgba(0, 120, 212, 0.2);
    }
    
    .fc-timegrid-event.fc-event-mirror {
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="list-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.equipment') }}">Equipment</a> / 
            <a href="{{ url_for('main.equipment_detail', equipment_id=equipment.id) }}">{{ equipment.name }}</a> / 
            Schedule
        </div>
    </div>
    
    <div class="detail-header">
        <h1>{{ equipment.name }} - Schedule</h1>
        <div class="detail-actions">
            <a href="{{ url_for('main.equipment_ical_feed', equipment_id=equipment.id) }}" class="btn btn-secondary btn-small" title="Subscribe to calendar">
                üì• iCal Feed
            </a>
            {% if g.current_user %}
            <a href="{{ url_for('main.equipment_book', equipment_id=equipment.id) }}" class="btn btn-primary">
                {{ icon_plus() }} Book Equipment
            </a>
            {% endif %}
            {% if g.current_user and (equipment.owner_id == g.current_user.id or g.current_user.role == 'admin') %}
            <a href="{{ url_for('main.equipment_schedule_settings', equipment_id=equipment.id) }}" class="btn btn-secondary">
                {{ icon_settings() }} Settings
            </a>
            {% endif %}
        </div>
    </div>
    
    {% if config and not config.scheduling_enabled %}
    <div class="detail-section-warning" style="padding: 1rem; margin-bottom: 1rem;">
        ‚ö†Ô∏è Scheduling is currently disabled for this equipment. Contact the equipment owner to enable it.
    </div>
    {% endif %}
    
    <!-- Calendar View -->
    <div class="calendar-container">
        <div id="calendar"></div>
    </div>
    
    <!-- Upcoming Bookings List -->
    <div class="detail-section">
        <h2>Upcoming Bookings</h2>
        {% if bookings %}
        {% for booking in bookings %}
        <div class="booking-card">
            <div class="time">
                {{ booking.start_time[:16] | replace('T', ' ') }}
            </div>
            <div class="details">
                <strong>{{ booking.title }}</strong>
                <span style="color: var(--color-text-secondary);">by {{ booking.user_name }}</span>
                {% if booking.project_name %}
                <span style="color: var(--color-text-secondary);">({{ booking.project_name }})</span>
                {% endif %}
            </div>
            <span class="status-badge status-{{ booking.status }}">{{ booking.status }}</span>
            <a href="{{ url_for('main.equipment_booking_detail', equipment_id=equipment.id, booking_id=booking.id) }}" class="btn btn-small btn-secondary">View</a>
        </div>
        {% endfor %}
        {% else %}
        <p class="empty-state">No upcoming bookings.</p>
        {% endif %}
    </div>
</div>

{% if g.current_user %}
<!-- Booking Confirmation Modal -->
<div id="booking-modal" class="booking-modal-overlay">
    <div class="booking-modal">
        <h2>üìÖ Confirm Booking Time</h2>
        <p style="color: var(--color-text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
            Click and drag on the calendar to select your time slot. Adjust the times below if needed.
        </p>
        
        <div class="booking-modal-times">
            <div class="form-group">
                <label for="modal-start-date">Start Date</label>
                <input type="date" id="modal-start-date">
            </div>
            <div class="form-group">
                <label for="modal-start-time">Start Time</label>
                <input type="time" id="modal-start-time">
            </div>
            <div class="form-group">
                <label for="modal-end-date">End Date</label>
                <input type="date" id="modal-end-date">
            </div>
            <div class="form-group">
                <label for="modal-end-time">End Time</label>
                <input type="time" id="modal-end-time">
            </div>
        </div>
        
        <div id="modal-duration" class="booking-modal-duration">
            Duration: --
        </div>
        
        <div id="modal-conflict" class="booking-modal-conflict hidden">
            <strong>‚ö†Ô∏è Conflict Detected:</strong>
            <span id="modal-conflict-message"></span>
        </div>
        
        <div class="booking-modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">Cancel</button>
            <button type="button" id="modal-confirm-btn" class="btn btn-primary" onclick="confirmBooking()">
                Continue to Booking Form ‚Üí
            </button>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
var calendar;
var checkAvailabilityTimeout;

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: '{{ url_for("main.equipment_calendar_events", equipment_id=equipment.id) }}',
        eventClick: function(info) {
            window.location.href = '{{ url_for("main.equipment_booking_detail", equipment_id=equipment.id, booking_id=0) }}'.replace('/0', '/' + info.event.id);
        },
        {% if g.current_user %}
        selectable: true,
        selectMirror: true,
        selectOverlap: false,
        select: function(info) {
            openBookingModal(info.start, info.end);
            calendar.unselect();
        },
        {% endif %}
        slotMinTime: '06:00:00',
        slotMaxTime: '22:00:00',
        allDaySlot: false,
        nowIndicator: true,
        weekends: true,
        height: 'auto',
        slotDuration: '00:30:00',
        snapDuration: '00:15:00',
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            meridiem: false,
            hour12: false
        }
    });
    calendar.render();
    
    // Add event listeners for modal time inputs
    {% if g.current_user %}
    ['modal-start-date', 'modal-start-time', 'modal-end-date', 'modal-end-time'].forEach(function(id) {
        document.getElementById(id).addEventListener('change', onModalTimeChange);
    });
    {% endif %}
});

{% if g.current_user %}
function openBookingModal(start, end) {
    var modal = document.getElementById('booking-modal');
    
    // Format dates for inputs
    var startDate = start.toISOString().split('T')[0];
    var startTime = start.toTimeString().slice(0, 5);
    var endDate = end.toISOString().split('T')[0];
    var endTime = end.toTimeString().slice(0, 5);
    
    document.getElementById('modal-start-date').value = startDate;
    document.getElementById('modal-start-time').value = startTime;
    document.getElementById('modal-end-date').value = endDate;
    document.getElementById('modal-end-time').value = endTime;
    
    // Update duration and check availability
    updateDuration();
    checkAvailability();
    
    modal.classList.add('active');
}

function closeBookingModal() {
    var modal = document.getElementById('booking-modal');
    modal.classList.remove('active');
    hideConflict();
}

function onModalTimeChange() {
    updateDuration();
    // Debounce availability check
    clearTimeout(checkAvailabilityTimeout);
    checkAvailabilityTimeout = setTimeout(checkAvailability, 300);
}

function updateDuration() {
    var startDate = document.getElementById('modal-start-date').value;
    var startTime = document.getElementById('modal-start-time').value;
    var endDate = document.getElementById('modal-end-date').value;
    var endTime = document.getElementById('modal-end-time').value;
    
    if (startDate && startTime && endDate && endTime) {
        var start = new Date(startDate + 'T' + startTime);
        var end = new Date(endDate + 'T' + endTime);
        var diffMs = end - start;
        
        if (diffMs > 0) {
            var hours = Math.floor(diffMs / 3600000);
            var minutes = Math.floor((diffMs % 3600000) / 60000);
            var durationText = '';
            if (hours > 0) durationText += hours + ' hour' + (hours > 1 ? 's' : '');
            if (minutes > 0) durationText += (hours > 0 ? ' ' : '') + minutes + ' minute' + (minutes > 1 ? 's' : '');
            document.getElementById('modal-duration').textContent = 'Duration: ' + durationText;
        } else {
            document.getElementById('modal-duration').textContent = 'Duration: Invalid (end must be after start)';
        }
    }
}

function checkAvailability() {
    var startDate = document.getElementById('modal-start-date').value;
    var startTime = document.getElementById('modal-start-time').value;
    var endDate = document.getElementById('modal-end-date').value;
    var endTime = document.getElementById('modal-end-time').value;
    
    if (!startDate || !startTime || !endDate || !endTime) return;
    
    var startISO = startDate + 'T' + startTime + ':00';
    var endISO = endDate + 'T' + endTime + ':00';
    
    var url = '{{ url_for("main.equipment_check_availability", equipment_id=equipment.id) }}' +
              '?start=' + encodeURIComponent(startISO) + 
              '&end=' + encodeURIComponent(endISO);
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                hideConflict();
                document.getElementById('modal-confirm-btn').disabled = false;
            } else {
                var messages = [];
                if (data.issues) {
                    data.issues.forEach(function(issue) {
                        messages.push(issue.message);
                    });
                }
                showConflict(messages.join('. ') || 'This time slot is not available');
                document.getElementById('modal-confirm-btn').disabled = true;
            }
        })
        .catch(function(error) {
            console.error('Error checking availability:', error);
        });
}

function showConflict(message) {
    var conflictDiv = document.getElementById('modal-conflict');
    document.getElementById('modal-conflict-message').textContent = message;
    conflictDiv.classList.remove('hidden');
}

function hideConflict() {
    document.getElementById('modal-conflict').classList.add('hidden');
}

function confirmBooking() {
    var startDate = document.getElementById('modal-start-date').value;
    var startTime = document.getElementById('modal-start-time').value;
    var endDate = document.getElementById('modal-end-date').value;
    var endTime = document.getElementById('modal-end-time').value;
    
    var startISO = startDate + 'T' + startTime + ':00';
    var endISO = endDate + 'T' + endTime + ':00';
    
    window.location.href = '{{ url_for("main.equipment_book", equipment_id=equipment.id) }}' +
        '?start=' + encodeURIComponent(startISO) +
        '&end=' + encodeURIComponent(endISO);
}

// Close modal on overlay click
document.getElementById('booking-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBookingModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBookingModal();
    }
});
{% endif %}
</script>
{% endblock %}
