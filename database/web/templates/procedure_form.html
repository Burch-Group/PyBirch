{% extends "base.html" %}

{% block title %}{{ action }} Procedure - PyBirch Database{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-nav">
        <a href="{{ url_for('main.procedures') }}" class="back-link">← Back to Procedures</a>
    </div>
    <h1>{{ action }} Procedure</h1>
</div>

{% if template %}
<div class="template-notice">
    <span class="template-badge">Using Template</span>
    <strong>{{ template.name }}</strong>
    {% if template.lab_name or (template.template_data and template.template_data.lab_name) %}
     - {{ template.lab_name or template.template_data.lab_name }}
    {% endif %}
    <p class="template-hint">Fields have been pre-filled from the template. You can modify them as needed.</p>
</div>
{% endif %}

<form method="POST" class="form-container">
    <!-- Lab & Project Assignment Section -->
    <div class="form-section">
        <h2>Assignment</h2>
        <div class="form-grid">
            <div class="form-group">
                <label for="lab_id">Lab</label>
                <select id="lab_id" name="lab_id" class="searchable-select" data-entity-type="lab">
                    <option value="">-- No Lab --</option>
                    {% for lab in labs %}
                    <option value="{{ lab.id }}" 
                            {% if (procedure and procedure.lab_id and procedure.lab_id == lab.id) or (default_lab_id == lab.id and (not procedure or not procedure.lab_id)) %}selected{% endif %}>
                        {{ lab.name }}
                    </option>
                    {% endfor %}
                </select>
                <small>Associate this procedure with a lab <a href="#" class="set-default-link" data-field="default_lab_id" data-source="lab_id">Set as default</a></small>
            </div>
            
            <div class="form-group">
                <label for="project_id">Project</label>
                <select id="project_id" name="project_id" class="searchable-select" data-entity-type="project">
                    <option value="">-- No Project --</option>
                    {% for project in projects %}
                    <option value="{{ project.id }}" 
                            {% if (procedure and procedure.project_id and procedure.project_id == project.id) or (default_project_id == project.id and (not procedure or not procedure.project_id)) %}selected{% endif %}>
                        {{ project.display }}
                    </option>
                    {% endfor %}
                </select>
                <small>Associate this procedure with a project <a href="#" class="set-default-link" data-field="default_project_id" data-source="project_id">Set as default</a></small>
            </div>
        </div>
    </div>

    <!-- Basic Information -->
    <div class="form-section">
        <h2>Basic Information</h2>
        <div class="form-grid">
            <div class="form-group full-width">
                <label for="name">Procedure Name *</label>
                <input type="text" id="name" name="name" required
                       value="{{ procedure.name if procedure else '' }}"
                       placeholder="e.g., Gold Thin Film Deposition">
            </div>
            
            <div class="form-group">
                <label for="procedure_type">Type</label>
                <select id="procedure_type" name="procedure_type">
                    <option value="">Select type...</option>
                    <option value="deposition" {% if procedure and procedure.procedure_type == 'deposition' %}selected{% endif %}>Deposition</option>
                    <option value="annealing" {% if procedure and procedure.procedure_type == 'annealing' %}selected{% endif %}>Annealing</option>
                    <option value="etching" {% if procedure and procedure.procedure_type == 'etching' %}selected{% endif %}>Etching</option>
                    <option value="cleaning" {% if procedure and procedure.procedure_type == 'cleaning' %}selected{% endif %}>Cleaning</option>
                    <option value="characterization" {% if procedure and procedure.procedure_type == 'characterization' %}selected{% endif %}>Characterization</option>
                    <option value="lithography" {% if procedure and procedure.procedure_type == 'lithography' %}selected{% endif %}>Lithography</option>
                    <option value="doping" {% if procedure and procedure.procedure_type == 'doping' %}selected{% endif %}>Doping</option>
                    <option value="oxidation" {% if procedure and procedure.procedure_type == 'oxidation' %}selected{% endif %}>Oxidation</option>
                    <option value="assembly" {% if procedure and procedure.procedure_type == 'assembly' %}selected{% endif %}>Assembly</option>
                    <option value="other" {% if procedure and procedure.procedure_type == 'other' %}selected{% endif %}>Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="version">Version</label>
                <input type="text" id="version" name="version"
                       value="{{ procedure.version if procedure else '1.0' }}"
                       placeholder="1.0">
            </div>
            
            <div class="form-group">
                <label for="estimated_duration_minutes">Est. Duration (minutes)</label>
                <input type="number" id="estimated_duration_minutes" name="estimated_duration_minutes"
                       value="{{ procedure.estimated_duration_minutes if procedure and procedure.estimated_duration_minutes else '' }}"
                       placeholder="e.g., 60" min="0">
            </div>
            
            <div class="form-group">
                <label for="created_by">Created By</label>
                <input type="text" id="created_by" name="created_by" readonly
                       value="{{ procedure.created_by if procedure else (current_user.username if current_user else '') }}">
            </div>
            
            <div class="form-group full-width">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="3"
                          placeholder="Detailed description of the procedure...">{{ procedure.description if procedure else '' }}</textarea>
            </div>
            
            <div class="form-group full-width">
                <label for="safety_requirements">Safety Requirements</label>
                <textarea id="safety_requirements" name="safety_requirements" rows="3"
                          placeholder="PPE requirements, hazards, emergency procedures...">{{ procedure.safety_requirements if procedure else '' }}</textarea>
            </div>
            
            <div class="form-group full-width">
                <label for="failure_modes">Failure Modes</label>
                <textarea id="failure_modes" name="failure_modes" rows="4"
                          placeholder="Enter one failure mode per line, e.g.:&#10;Film delamination&#10;Uneven deposition&#10;Target contamination&#10;Temperature overshoot">{{ procedure.failure_modes|join('\n') if procedure and procedure.failure_modes else '' }}</textarea>
                <small class="form-hint">Define possible failure modes for this procedure (one per line). These will be available to select when marking a fabrication run as failed.</small>
            </div>
        </div>
    </div>
    
    <!-- Procedure-Level Parameters -->
    <div class="form-section">
        <h2>Procedure Parameters</h2>
        <p class="form-help">Define parameters that apply to the entire procedure. Users can override these values during fabrication runs.</p>
        
        <div id="procedure-params-container">
            {% if procedure and procedure.parameters %}
                {% for param in procedure.parameters %}
                <div class="param-item">
                    <input type="text" name="proc_param_name[]" value="{{ param.name }}" placeholder="Parameter name" class="param-name">
                    <select name="proc_param_type[]" class="param-type">
                        <option value="text" {% if param.type == 'text' %}selected{% endif %}>Text</option>
                        <option value="number" {% if param.type == 'number' %}selected{% endif %}>Number</option>
                        <option value="select" {% if param.type == 'select' %}selected{% endif %}>Select</option>
                        <option value="checkbox" {% if param.type == 'checkbox' %}selected{% endif %}>Checkbox</option>
                    </select>
                    <input type="text" name="proc_param_default[]" value="{{ param.default }}" placeholder="Default value" class="param-default">
                    <input type="text" name="proc_param_unit[]" value="{{ param.unit or '' }}" placeholder="Unit (optional)" class="param-unit">
                    <input type="text" name="proc_param_options[]" value="{{ param.options|join(',') if param.options else '' }}" placeholder="Options (comma-sep)" class="param-options">
                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">✕</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        <button type="button" class="btn btn-secondary" onclick="addProcedureParam()">+ Add Parameter</button>
    </div>

    <div class="form-section">
        <h2>Procedure Steps</h2>
        <p class="form-help">Define the steps in order. Each step can have a name, description, duration, and its own parameters.</p>
        
        <div id="steps-container">
            {% if procedure and procedure.steps %}
                {% for step in procedure.steps %}
                <div class="step-form-item" data-step-index="{{ loop.index0 }}">
                    <div class="step-form-header">
                        <span class="step-form-number">{{ loop.index }}</span>
                        <button type="button" class="btn btn-small btn-danger remove-step-btn" onclick="removeStep(this)">Remove</button>
                    </div>
                    <div class="step-form-fields">
                        <div class="form-group">
                            <label>Step Name *</label>
                            <input type="text" name="step_name[]" required
                                   value="{{ step.name if step is mapping else step }}"
                                   placeholder="e.g., Substrate cleaning">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" name="step_description[]"
                                   value="{{ step.description if step is mapping and step.description else '' }}"
                                   placeholder="Details about this step">
                        </div>
                        <div class="form-group step-duration">
                            <label>Duration (min)</label>
                            <input type="number" name="step_duration[]" min="0"
                                   value="{{ step.duration_minutes if step is mapping and step.duration_minutes else '' }}"
                                   placeholder="0">
                        </div>
                    </div>
                    <div class="step-params-section">
                        <label class="step-params-label">Step Parameters:</label>
                        <div class="step-params-container">
                            {% if step is mapping and step.parameters %}
                                {% for param in step.parameters %}
                                <div class="param-item step-param">
                                    <input type="hidden" name="step_param_step_idx[]" value="{{ loop.index0 }}">
                                    <input type="text" name="step_param_name_{{ loop.index0 }}[]" value="{{ param.name }}" placeholder="Parameter name" class="param-name">
                                    <select name="step_param_type_{{ loop.index0 }}[]" class="param-type">
                                        <option value="text" {% if param.type == 'text' %}selected{% endif %}>Text</option>
                                        <option value="number" {% if param.type == 'number' %}selected{% endif %}>Number</option>
                                        <option value="select" {% if param.type == 'select' %}selected{% endif %}>Select</option>
                                        <option value="checkbox" {% if param.type == 'checkbox' %}selected{% endif %}>Checkbox</option>
                                    </select>
                                    <input type="text" name="step_param_default_{{ loop.index0 }}[]" value="{{ param.default }}" placeholder="Default" class="param-default">
                                    <input type="text" name="step_param_unit_{{ loop.index0 }}[]" value="{{ param.unit or '' }}" placeholder="Unit" class="param-unit">
                                    <input type="text" name="step_param_options_{{ loop.index0 }}[]" value="{{ param.options|join(',') if param.options else '' }}" placeholder="Options" class="param-options">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">✕</button>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addStepParam(this)">+ Add Step Parameter</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="step-form-item" data-step-index="0">
                    <div class="step-form-header">
                        <span class="step-form-number">1</span>
                        <button type="button" class="btn btn-small btn-danger remove-step-btn" onclick="removeStep(this)">Remove</button>
                    </div>
                    <div class="step-form-fields">
                        <div class="form-group">
                            <label>Step Name *</label>
                            <input type="text" name="step_name[]" placeholder="e.g., Substrate cleaning">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" name="step_description[]" placeholder="Details about this step">
                        </div>
                        <div class="form-group step-duration">
                            <label>Duration (min)</label>
                            <input type="number" name="step_duration[]" min="0" placeholder="0">
                        </div>
                    </div>
                    <div class="step-params-section">
                        <label class="step-params-label">Step Parameters:</label>
                        <div class="step-params-container"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addStepParam(this)">+ Add Step Parameter</button>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <button type="button" class="btn btn-secondary" onclick="addStep()">+ Add Step</button>
    </div>
    
    <!-- Equipment Section -->
    <div class="form-section">
        <h2>Required Equipment</h2>
        <p class="form-help">Select the equipment (e.g., gloveboxes, chambers, machines) needed for this procedure.</p>
        
        <div id="equipment-container">
            {% if linked_equipment_ids %}
                {% for equip_id in linked_equipment_ids %}
                <div class="linked-equipment-item">
                    <select name="equipment_ids[]" class="equipment-select">
                        <option value="">Select equipment...</option>
                        {% for equip in equipment %}
                        <option value="{{ equip.id }}" {% if equip.id == equip_id %}selected{% endif %}>
                            {{ equip.name }}{% if equip.model %} ({{ equip.model }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeEquipment(this)">✕</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
        
        <button type="button" class="btn btn-secondary" onclick="addEquipment()">+ Add Equipment</button>
    </div>
    
    <div class="form-actions">
        <a href="{{ url_for('main.procedures') }}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">{{ action }} Procedure</button>
    </div>
</form>

<script>
// Equipment data for dynamic dropdowns
const equipmentData = [
    {% for equip in equipment %}
    {id: {{ equip.id }}, name: "{{ equip.name }}", model: "{{ equip.model or '' }}"},
    {% endfor %}
];

function addEquipment() {
    const container = document.getElementById('equipment-container');
    const div = document.createElement('div');
    div.className = 'linked-equipment-item';
    
    let options = '<option value="">Select equipment...</option>';
    equipmentData.forEach(e => {
        const display = e.model ? `${e.name} (${e.model})` : e.name;
        options += `<option value="${e.id}">${display}</option>`;
    });
    
    div.innerHTML = `
        <select name="equipment_ids[]" class="equipment-select">${options}</select>
        <button type="button" class="btn btn-sm btn-danger" onclick="removeEquipment(this)">✕</button>
    `;
    container.appendChild(div);
}

function removeEquipment(button) {
    button.parentElement.remove();
}

// Procedure-level parameter functions
function addProcedureParam() {
    const container = document.getElementById('procedure-params-container');
    const paramHtml = `
        <div class="param-item">
            <input type="text" name="proc_param_name[]" placeholder="Parameter name" class="param-name">
            <select name="proc_param_type[]" class="param-type">
                <option value="text">Text</option>
                <option value="number">Number</option>
                <option value="select">Select</option>
                <option value="checkbox">Checkbox</option>
            </select>
            <input type="text" name="proc_param_default[]" placeholder="Default value" class="param-default">
            <input type="text" name="proc_param_unit[]" placeholder="Unit (optional)" class="param-unit">
            <input type="text" name="proc_param_options[]" placeholder="Options (comma-sep)" class="param-options">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">✕</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', paramHtml);
}

// Step parameter functions
function addStepParam(button) {
    const stepItem = button.closest('.step-form-item');
    const stepIndex = stepItem.dataset.stepIndex;
    const container = stepItem.querySelector('.step-params-container');
    
    const paramHtml = `
        <div class="param-item step-param">
            <input type="text" name="step_param_name_${stepIndex}[]" placeholder="Parameter name" class="param-name">
            <select name="step_param_type_${stepIndex}[]" class="param-type">
                <option value="text">Text</option>
                <option value="number">Number</option>
                <option value="select">Select</option>
                <option value="checkbox">Checkbox</option>
            </select>
            <input type="text" name="step_param_default_${stepIndex}[]" placeholder="Default" class="param-default">
            <input type="text" name="step_param_unit_${stepIndex}[]" placeholder="Unit" class="param-unit">
            <input type="text" name="step_param_options_${stepIndex}[]" placeholder="Options" class="param-options">
            <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">✕</button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', paramHtml);
}

let stepCount = document.querySelectorAll('.step-form-item').length;

function addStep() {
    stepCount++;
    const newIndex = stepCount - 1;
    const container = document.getElementById('steps-container');
    const stepHtml = `
        <div class="step-form-item" data-step-index="${newIndex}">
            <div class="step-form-header">
                <span class="step-form-number">${stepCount}</span>
                <button type="button" class="btn btn-small btn-danger remove-step-btn" onclick="removeStep(this)">Remove</button>
            </div>
            <div class="step-form-fields">
                <div class="form-group">
                    <label>Step Name *</label>
                    <input type="text" name="step_name[]" placeholder="e.g., Substrate cleaning">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="step_description[]" placeholder="Details about this step">
                </div>
                <div class="form-group step-duration">
                    <label>Duration (min)</label>
                    <input type="number" name="step_duration[]" min="0" placeholder="0">
                </div>
            </div>
            <div class="step-params-section">
                <label class="step-params-label">Step Parameters:</label>
                <div class="step-params-container"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addStepParam(this)">+ Add Step Parameter</button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', stepHtml);
    renumberSteps();
}

function removeStep(button) {
    const stepItem = button.closest('.step-form-item');
    stepItem.remove();
    renumberSteps();
}

function renumberSteps() {
    const steps = document.querySelectorAll('.step-form-item');
    steps.forEach((step, index) => {
        step.querySelector('.step-form-number').textContent = index + 1;
        const oldIndex = step.dataset.stepIndex;
        step.dataset.stepIndex = index;
        
        // Update parameter input names to match new step index
        step.querySelectorAll('.step-param input, .step-param select').forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/_\d+\[\]$/, `_${index}[]`);
            }
        });
    });
    stepCount = steps.length;
}
</script>

<style>
.template-notice {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    border: 1px solid #81c784;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
}
.template-badge {
    background: #4caf50;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    margin-right: 0.5rem;
}
.template-notice strong { color: #2e7d32; }
.template-hint {
    margin: 0.5rem 0 0 0;
    font-size: 0.9rem;
    color: #558b2f;
}

/* Equipment Section */
.linked-equipment-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
}
.linked-equipment-item select {
    flex: 1;
}
#equipment-container {
    margin-bottom: 1rem;
}

/* Parameter Items */
.param-item {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
}
.param-item .param-name {
    flex: 2;
    min-width: 120px;
}
.param-item .param-type {
    flex: 1;
    min-width: 80px;
}
.param-item .param-default {
    flex: 1.5;
    min-width: 100px;
}
.param-item .param-unit {
    flex: 1;
    min-width: 60px;
}
.param-item .param-options {
    flex: 2;
    min-width: 120px;
}
#procedure-params-container {
    margin-bottom: 1rem;
}

/* Step Parameters */
.step-params-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px dashed #e0e0e0;
}
.step-params-label {
    font-weight: 500;
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    display: block;
}
.step-params-container {
    margin-bottom: 0.5rem;
}
.step-param {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 4px;
}
</style>
{% endblock %}
