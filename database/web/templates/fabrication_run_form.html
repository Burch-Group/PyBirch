{% extends "base.html" %}

{% block title %}{{ action }} Fabrication Run - {{ sample.sample_id }} - PyBirch Database{% endblock %}

{% block content %}
<div class="form-page">
    <div class="page-header">
        <div class="breadcrumb">
            <a href="{{ url_for('main.samples') }}">Samples</a> / 
            <a href="{{ url_for('main.sample_detail', sample_id=sample.id) }}">{{ sample.sample_id }}</a> / 
            {{ action }} Fabrication Run
        </div>
    </div>

    <div class="form-container">
        <h1>{{ action }} Fabrication Run</h1>
        <p class="form-subtitle">For sample: <strong>{{ sample.sample_id }}</strong> {% if sample.name %}- {{ sample.name }}{% endif %}</p>
        
        <form method="POST" class="entity-form">
            <div class="form-section">
                <h2>‚öóÔ∏è Run Details</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="procedure_id">Procedure *</label>
                        <select id="procedure_id" name="procedure_id" required class="searchable-select" data-entity-type="procedure" onchange="loadProcedureParams(); updateFailureModes();">
                            <option value="">Select a procedure...</option>
                            {% for proc in procedures %}
                            <option value="{{ proc.id }}" 
                                    data-parameters='{{ proc.parameters|tojson if proc.parameters else "[]" }}'
                                    data-steps='{{ proc.steps|tojson if proc.steps else "[]" }}'
                                    data-failure-modes='{{ proc.failure_modes|tojson if proc.failure_modes else "[]" }}'
                                    {% if run and run.procedure_id == proc.id %}selected{% endif %}>
                                {{ proc.name }} {% if proc.procedure_type %}({{ proc.procedure_type }}){% endif %} v{{ proc.version }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="run_number">Run Number</label>
                        <input type="number" id="run_number" name="run_number" min="1"
                               value="{{ run.run_number if run and run.run_number else '' }}"
                               placeholder="Order in fabrication sequence">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status *</label>
                        <select id="status" name="status" required onchange="toggleFailureMode()">
                            <option value="pending" {% if not run or run.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="in_progress" {% if run and run.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if run and run.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="failed" {% if run and run.status == 'failed' %}selected{% endif %}>Failed</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="failure-mode-group" style="display: none;">
                        <label for="failure_mode">Failure Mode</label>
                        <select id="failure_mode" name="failure_mode">
                            <option value="">Select failure mode...</option>
                        </select>
                        <small class="form-hint">Select the type of failure that occurred</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="created_by">Operator</label>
                        <input type="text" id="created_by" name="created_by" 
                               value="{{ run.created_by if run else g.current_user.username if g.current_user else '' }}"
                               placeholder="Person performing this run">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="started_at">Started At</label>
                        <input type="datetime-local" id="started_at" name="started_at"
                               value="{{ run.started_at[:16] if run and run.started_at else now }}">
                    </div>
                    
                    {% if run %}
                    <div class="form-group">
                        <label for="completed_at">Completed At</label>
                        <input type="datetime-local" id="completed_at" name="completed_at"
                               value="{{ run.completed_at[:16] if run.completed_at else '' }}">
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Procedure Parameters Section (dynamically populated) -->
            <div class="form-section" id="procedure-params-section" style="display: none;">
                <h2>‚öôÔ∏è Procedure Parameters</h2>
                <p class="form-help">These are the default parameters for this procedure. Modify values as needed for this run.</p>
                <div id="procedure-params-container"></div>
            </div>
            
            <!-- Step Parameters Section (dynamically populated) -->
            <div class="form-section" id="step-params-section" style="display: none;">
                <h2>üìã Step Parameters</h2>
                <p class="form-help">Parameters for each step in the procedure. Modify values as needed.</p>
                <div id="step-params-container"></div>
            </div>
            
            <!-- Precursors Consumed Section -->
            <div class="form-section">
                <h2>üß™ Precursors Consumed</h2>
                <p class="form-help">Record the precursors used in this fabrication run and the quantities consumed.</p>
                
                <div id="precursors-container">
                    {% if run_precursors %}
                        {% for rp in run_precursors %}
                        <div class="precursor-row">
                            <div class="precursor-fields precursor-fields--fabrication-run">
                                <div class="form-group">
                                    <label>Precursor</label>
                                    <select name="precursor_id[]" class="searchable-select" data-entity-type="precursor">
                                        <option value="">Select precursor...</option>
                                        {% for p in precursors %}
                                        <option value="{{ p.id }}" {% if p.id == rp.precursor_id %}selected{% endif %}>
                                            {{ p.display }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Quantity Consumed</label>
                                    <input type="number" step="any" name="precursor_quantity[]" value="{{ rp.quantity_consumed or '' }}" placeholder="Amount">
                                </div>
                                <div class="form-group">
                                    <label>Unit</label>
                                    <input type="text" name="precursor_unit[]" value="{{ rp.quantity_unit or '' }}" placeholder="g, mL, etc.">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" name="precursor_notes[]" value="{{ rp.notes or '' }}" placeholder="Optional notes">
                                </div>
                                <button type="button" class="btn btn-icon btn-danger remove-precursor" title="Remove" onclick="this.closest('.precursor-row').remove()">
                                    <span>‚úï</span>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <button type="button" class="btn btn-secondary btn-sm" onclick="addPrecursor()">+ Add Precursor</button>
            </div>
            
            <div class="form-section">
                <h2>üìù Notes & Results</h2>
                
                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" name="notes" rows="4" 
                              placeholder="Any observations or notes about this run...">{{ run.notes if run else '' }}</textarea>
                </div>
                
                {% if run %}
                <div class="form-group">
                    <label for="results">Results</label>
                    <textarea id="results" name="results" rows="4" 
                              placeholder="Outcome and results of this fabrication run...">{{ run.results if run else '' }}</textarea>
                </div>
                {% endif %}
            </div>
            
            <div class="form-actions">
                <a href="{{ url_for('main.sample_detail', sample_id=sample.id) }}" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">{{ action }} Fabrication Run</button>
            </div>
        </form>
    </div>
</div>

<style>
.form-subtitle {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
}
.param-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
}
.param-row label {
    min-width: 150px;
    font-weight: 500;
    margin: 0;
}
.param-row .param-input {
    flex: 1;
}
.param-row input[type="checkbox"].param-input {
    flex: none;
    width: 18px;
    height: 18px;
}
.param-row .param-unit {
    color: #666;
    font-size: 0.9rem;
    min-width: 50px;
}
.param-row .param-default {
    color: #999;
    font-size: 0.85rem;
}
.step-params-group {
    margin-bottom: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}
.step-params-header {
    background: #f0f0f0;
    padding: 0.75rem 1rem;
    font-weight: 600;
    border-bottom: 1px solid #e0e0e0;
}
.step-params-body {
    padding: 1rem;
}
.no-params {
    color: #999;
    font-style: italic;
    padding: 0.5rem 0;
}
</style>

<script>
// Store actual parameter values from existing run
const existingParams = {{ run.actual_parameters|tojson if run and run.actual_parameters else '{}' }};

function loadProcedureParams() {
    const select = document.getElementById('procedure_id');
    const option = select.options[select.selectedIndex];
    
    if (!option.value) {
        document.getElementById('procedure-params-section').style.display = 'none';
        document.getElementById('step-params-section').style.display = 'none';
        return;
    }
    
    let parameters = [];
    let steps = [];
    
    try {
        parameters = JSON.parse(option.dataset.parameters || '[]');
        steps = JSON.parse(option.dataset.steps || '[]');
    } catch (e) {
        console.error('Error parsing procedure data:', e);
    }
    
    // Render procedure-level parameters
    const procParamsContainer = document.getElementById('procedure-params-container');
    const procParamsSection = document.getElementById('procedure-params-section');
    
    if (parameters && parameters.length > 0) {
        procParamsSection.style.display = 'block';
        procParamsContainer.innerHTML = parameters.map(param => {
            const savedValue = existingParams.procedure_parameters ? existingParams.procedure_parameters[param.name] : null;
            const value = savedValue !== null && savedValue !== undefined ? savedValue : param.default;
            return renderParamInput(param, `proc_param[${param.name}]`, value);
        }).join('');
    } else {
        procParamsSection.style.display = 'none';
        procParamsContainer.innerHTML = '';
    }
    
    // Render step parameters
    const stepParamsContainer = document.getElementById('step-params-container');
    const stepParamsSection = document.getElementById('step-params-section');
    
    const stepsWithParams = steps.filter(step => step.parameters && step.parameters.length > 0);
    
    if (stepsWithParams.length > 0) {
        stepParamsSection.style.display = 'block';
        stepParamsContainer.innerHTML = steps.map((step, stepIndex) => {
            if (!step.parameters || step.parameters.length === 0) return '';
            
            const stepSavedParams = existingParams.step_parameters ? existingParams.step_parameters[stepIndex] : {};
            
            const paramsHtml = step.parameters.map(param => {
                const savedValue = stepSavedParams ? stepSavedParams[param.name] : null;
                const value = savedValue !== null && savedValue !== undefined ? savedValue : param.default;
                return renderParamInput(param, `step_param[${stepIndex}][${param.name}]`, value);
            }).join('');
            
            return `
                <div class="step-params-group">
                    <div class="step-params-header">
                        Step ${stepIndex + 1}: ${step.name}
                    </div>
                    <div class="step-params-body">
                        ${paramsHtml}
                    </div>
                </div>
            `;
        }).join('');
    } else {
        stepParamsSection.style.display = 'none';
        stepParamsContainer.innerHTML = '';
    }
}

function renderParamInput(param, inputName, value) {
    let inputHtml = '';
    const escapedValue = value !== null && value !== undefined ? String(value).replace(/"/g, '&quot;') : '';
    
    if (param.type === 'select' && param.options && param.options.length > 0) {
        const optionsHtml = param.options.map(opt => 
            `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`
        ).join('');
        inputHtml = `<select name="${inputName}" class="param-input">${optionsHtml}</select>`;
    } else if (param.type === 'checkbox') {
        const checked = value === true || value === 'true' || value === '1' || value === 'yes';
        inputHtml = `<input type="checkbox" name="${inputName}" class="param-input" ${checked ? 'checked' : ''} value="true">`;
    } else if (param.type === 'number') {
        inputHtml = `<input type="number" name="${inputName}" class="param-input" value="${escapedValue}" step="any">`;
    } else {
        inputHtml = `<input type="text" name="${inputName}" class="param-input" value="${escapedValue}">`;
    }
    
    const unitHtml = param.unit ? `<span class="param-unit">${param.unit}</span>` : '';
    const defaultHtml = param.default !== undefined && param.default !== '' ? 
        `<span class="param-default">(default: ${param.default}${param.unit ? ' ' + param.unit : ''})</span>` : '';
    
    return `
        <div class="param-row">
            <label>${param.name}</label>
            ${inputHtml}
            ${unitHtml}
            ${defaultHtml}
        </div>
    `;
}

// Store existing failure mode for edit mode
const existingFailureMode = '{{ run.failure_mode if run and run.failure_mode else "" }}';

function toggleFailureMode() {
    const status = document.getElementById('status').value;
    const failureModeGroup = document.getElementById('failure-mode-group');
    
    if (status === 'failed') {
        failureModeGroup.style.display = 'block';
        updateFailureModes();
    } else {
        failureModeGroup.style.display = 'none';
        document.getElementById('failure_mode').value = '';
    }
}

function updateFailureModes() {
    const procedureSelect = document.getElementById('procedure_id');
    const failureModeSelect = document.getElementById('failure_mode');
    const option = procedureSelect.options[procedureSelect.selectedIndex];
    
    // Clear existing options except the first one
    failureModeSelect.innerHTML = '<option value="">Select failure mode...</option>';
    
    if (!option || !option.value) return;
    
    let failureModes = [];
    try {
        failureModes = JSON.parse(option.dataset.failureModes || '[]');
    } catch (e) {
        console.error('Error parsing failure modes:', e);
    }
    
    // Add failure mode options
    failureModes.forEach(mode => {
        const opt = document.createElement('option');
        opt.value = mode;
        opt.textContent = mode;
        if (mode === existingFailureMode) {
            opt.selected = true;
        }
        failureModeSelect.appendChild(opt);
    });
    
    // Add "Other" option to allow custom input
    if (failureModes.length > 0) {
        const otherOpt = document.createElement('option');
        otherOpt.value = '_other';
        otherOpt.textContent = '-- Other (specify) --';
        failureModeSelect.appendChild(otherOpt);
    }
    
    // If existing failure mode wasn't in the list, add it and select it
    if (existingFailureMode && !failureModes.includes(existingFailureMode)) {
        const customOpt = document.createElement('option');
        customOpt.value = existingFailureMode;
        customOpt.textContent = existingFailureMode;
        customOpt.selected = true;
        failureModeSelect.insertBefore(customOpt, failureModeSelect.lastChild);
    }
}

// Handle "Other" selection for custom failure mode
document.getElementById('failure_mode').addEventListener('change', function() {
    if (this.value === '_other') {
        const customMode = prompt('Enter the failure mode:');
        if (customMode && customMode.trim()) {
            const opt = document.createElement('option');
            opt.value = customMode.trim();
            opt.textContent = customMode.trim();
            opt.selected = true;
            this.insertBefore(opt, this.lastChild);
        } else {
            this.value = '';
        }
    }
});

// Precursor data for dynamic dropdowns
const precursorData = [
    {% for p in precursors %}
    {id: {{ p.id }}, display: "{{ p.display|e }}"},
    {% endfor %}
];

function addPrecursor() {
    const container = document.getElementById('precursors-container');
    const div = document.createElement('div');
    div.className = 'precursor-row';
    
    let options = '<option value="">Select precursor...</option>';
    precursorData.forEach(p => {
        options += `<option value="${p.id}">${p.display}</option>`;
    });
    
    div.innerHTML = `
        <div class="precursor-fields precursor-fields--fabrication-run">
            <div class="form-group">
                <label>Precursor</label>
                <select name="precursor_id[]" class="searchable-select" data-entity-type="precursor">${options}</select>
            </div>
            <div class="form-group">
                <label>Quantity Consumed</label>
                <input type="number" step="any" name="precursor_quantity[]" placeholder="Amount">
            </div>
            <div class="form-group">
                <label>Unit</label>
                <input type="text" name="precursor_unit[]" placeholder="g, mL, etc.">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <input type="text" name="precursor_notes[]" placeholder="Optional notes">
            </div>
            <button type="button" class="btn btn-icon btn-danger remove-precursor" title="Remove" onclick="this.closest('.precursor-row').remove()">
                <span>‚úï</span>
            </button>
        </div>
    `;
    container.appendChild(div);
    
    // Initialize searchable select if available
    if (typeof initializeSearchableSelects === 'function') {
        initializeSearchableSelects();
    }
}

// Load parameters on page load if procedure is already selected
document.addEventListener('DOMContentLoaded', function() {
    loadProcedureParams();
    toggleFailureMode();
});
</script>
{% endblock %}
